<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR ValueSet Creator</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --input-bg: #ffffff;
            --json-bg: #1e293b;
            --json-text: #e2e8f0;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --input-bg: #0f172a;
            --json-bg: #020617;
            --json-text: #e2e8f0;
        }

        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --primary: #3b82f6;
                --primary-dark: #2563eb;
                --bg: #0f172a;
                --card-bg: #1e293b;
                --text: #f1f5f9;
                --text-muted: #94a3b8;
                --border: #334155;
                --input-bg: #0f172a;
                --json-bg: #020617;
                --json-text: #e2e8f0;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        h1 {
            grid-column: 1 / -1;
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            grid-column: 1 / -1;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .label-hint {
            font-weight: normal;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        input[type="text"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.875rem;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text);
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input {
            width: auto;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .load-section {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .load-section input[type="file"] {
            display: none;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
        }

        .radio-option:hover {
            background: var(--bg);
        }

        .radio-option.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .radio-option input {
            margin: 0;
        }

        .compose-content {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg);
            border-radius: 4px;
            display: none;
        }

        .compose-content.active {
            display: block;
        }

        .code-list-input {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            min-height: 150px;
        }

        .preview-section {
            position: sticky;
            top: 2rem;
        }

        .json-preview {
            background: var(--json-bg);
            color: var(--json-text);
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .json-key { color: #7dd3fc; }
        .json-string { color: #86efac; }
        .json-number { color: #fcd34d; }
        .json-boolean { color: #f472b6; }

        .output-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 4px;
            background: var(--success);
            color: white;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .identifier-input {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .identifier-prefix {
            color: var(--text-muted);
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .version-highlight {
            border-color: var(--warning) !important;
            background: rgba(245, 158, 11, 0.1);
        }

        .validation-error {
            color: var(--error);
            font-size: 0.75rem;
        }

        .validation-warning {
            color: var(--warning);
            font-size: 0.75rem;
        }

        .validation-info {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .input-error {
            border-color: var(--error) !important;
        }

        .input-warning {
            border-color: var(--warning) !important;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .code-system-select {
            margin-bottom: 0.5rem;
        }

        .header-row {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .theme-toggle button {
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .theme-toggle button:hover {
            background: var(--border);
        }

        .theme-toggle button.active {
            background: var(--primary);
            color: white;
        }

        .copyright-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 40px;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 4px;
            border: 1px dashed var(--border);
        }

        .copyright-list:empty::before {
            content: "No copyright notices added yet";
            color: var(--text-muted);
            font-size: 0.875rem;
            text-align: center;
            display: block;
            padding: 0.5rem;
        }

        .copyright-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: move;
            transition: all 0.2s;
        }

        .copyright-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .copyright-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .copyright-item.drag-over {
            border-top: 2px solid var(--primary);
        }

        .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            font-size: 1.2rem;
            padding: 0 0.25rem;
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .copyright-item-name {
            flex: 1;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .copyright-item-category {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.125rem 0.5rem;
            background: var(--bg);
            border-radius: 3px;
        }

        .remove-copyright {
            background: none;
            border: none;
            color: var(--error);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            transition: all 0.2s;
        }

        .remove-copyright:hover {
            color: var(--primary-dark);
            transform: scale(1.2);
        }

        /* Include blocks list */
        .include-blocks-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 60px;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 4px;
            border: 1px dashed var(--border);
        }

        .include-blocks-list:empty::before {
            content: "No include blocks added yet";
            color: var(--text-muted);
            font-size: 0.875rem;
            text-align: center;
            display: block;
            padding: 1rem;
        }

        .include-block-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: move;
            transition: all 0.2s;
        }

        .include-block-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .include-block-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .include-block-item.drag-over {
            border-top: 2px solid var(--primary);
        }

        .include-block-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .include-block-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text);
        }

        .include-block-summary {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .include-block-badge {
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            color: white;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .include-block-badge:hover {
            background: var(--primary-dark);
        }

        .remove-include {
            background: none;
            border: none;
            color: var(--error);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            transition: all 0.2s;
        }

        .remove-include:hover {
            color: var(--primary-dark);
            transform: scale(1.2);
        }

        /* Navigation buttons for reordering */
        .copyright-nav-buttons,
        .include-nav-buttons {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .move-up-btn,
        .move-down-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.875rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            transition: all 0.2s;
            line-height: 1;
        }

        .move-up-btn:hover:not(:disabled),
        .move-down-btn:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .move-up-btn:disabled,
        .move-down-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            position: relative;
            background: var(--card-bg);
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--text);
        }

        /* Validation Report Styles */
        .btn-info {
            background: var(--info, #3b82f6);
            color: white;
            position: relative;
        }

        .btn-info:hover {
            background: var(--info-dark, #2563eb);
        }

        .validation-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .validation-badge.warning-only {
            background: var(--warning);
        }

        .validation-summary {
            padding: 1rem;
            background: var(--bg);
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .validation-summary.success {
            border-left: 4px solid var(--success);
        }

        .validation-summary.has-warnings {
            border-left: 4px solid var(--warning);
        }

        .validation-summary.has-errors {
            border-left: 4px solid var(--error);
        }

        .validation-section {
            margin-bottom: 1rem;
        }

        .expandable-section {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .section-header {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            user-select: none;
            transition: background 0.2s;
        }

        .section-header:hover {
            background: var(--card-bg);
        }

        .section-header.error {
            color: var(--error);
        }

        .section-header.warning {
            color: var(--warning);
        }

        .section-header.success {
            color: var(--success);
        }

        .section-icon {
            font-size: 1rem;
            transition: transform 0.2s;
        }

        .section-icon.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 0 1rem 1rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .section-content.collapsed {
            display: none;
        }

        .validation-item {
            padding: 0.5rem;
            border-left: 3px solid var(--border);
            background: var(--card-bg);
            border-radius: 3px;
            font-size: 0.875rem;
        }

        .validation-item.error {
            border-left-color: var(--error);
            background: color-mix(in srgb, var(--error) 10%, var(--card-bg));
        }

        .validation-item.warning {
            border-left-color: var(--warning);
            background: color-mix(in srgb, var(--warning) 10%, var(--card-bg));
        }

        .validation-item.info {
            border-left-color: var(--success);
            background: color-mix(in srgb, var(--success) 10%, var(--card-bg));
        }

        .validation-note {
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 1rem;
        }

        /* Diff View Styles */
        .diff-summary {
            padding: 1rem;
            background: var(--bg);
            border-radius: 4px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .diff-summary-counts {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .diff-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .diff-count-modified {
            color: var(--warning);
        }

        .diff-count-added {
            color: var(--success);
        }

        .diff-count-removed {
            color: var(--error);
        }

        .diff-section {
            margin-bottom: 1rem;
        }

        .diff-section-header {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .diff-section-header:hover {
            background: color-mix(in srgb, var(--primary) 10%, var(--bg));
        }

        .diff-section-icon {
            transition: transform 0.2s;
        }

        .diff-section-icon.collapsed {
            transform: rotate(-90deg);
        }

        .diff-section-content {
            margin-top: 0.5rem;
        }

        .diff-section-content.collapsed {
            display: none;
        }

        .diff-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            border-left: 3px solid;
        }

        .diff-item-modified {
            border-left-color: var(--warning);
            background: color-mix(in srgb, var(--warning) 10%, var(--card-bg));
        }

        .diff-item-added {
            border-left-color: var(--success);
            background: color-mix(in srgb, var(--success) 10%, var(--card-bg));
        }

        .diff-item-removed {
            border-left-color: var(--error);
            background: color-mix(in srgb, var(--error) 10%, var(--card-bg));
        }

        .diff-path {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
            font-size: 0.8125rem;
        }

        .diff-value {
            padding: 0.5rem;
            background: var(--json-bg);
            border-radius: 3px;
            margin: 0.25rem 0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .diff-value-label {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .diff-value-old .diff-value-label {
            color: var(--error);
        }

        .diff-value-new .diff-value-label {
            color: var(--success);
        }

        .diff-empty-state {
            padding: 3rem 2rem;
            text-align: center;
            color: var(--text-muted);
        }

        .diff-empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .diff-json-comparison {
            margin-top: 1rem;
        }

        .diff-json-panes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .diff-json-pane {
            background: var(--json-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .diff-json-pane-header {
            padding: 0.5rem 0.75rem;
            background: var(--bg);
            font-weight: 600;
            font-size: 0.8125rem;
            border-bottom: 1px solid var(--border);
        }

        .diff-json-pane-content {
            padding: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.75rem;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <div class="header-title">
                <h1 style="margin-bottom: 0;">FHIR ValueSet Creator</h1>
                <p class="subtitle" style="margin-bottom: 0;">Create FHIR R4 ValueSet resources for download</p>
            </div>
            <div class="header-actions">
                <a href="https://github.com/MattCordell/Stoker/issues/new" target="_blank" rel="noopener noreferrer" class="btn btn-secondary" aria-label="Report bug on GitHub (opens in new tab)">
                    üêõ Report Bug
                </a>
                <div class="theme-toggle">
                    <button id="theme-system" onclick="setTheme('system')" title="System" aria-label="System theme">Auto</button>
                    <button id="theme-light" onclick="setTheme('light')" title="Light" aria-label="Light theme">‚òÄÔ∏è</button>
                    <button id="theme-dark" onclick="setTheme('dark')" title="Dark" aria-label="Dark theme">üåô</button>
                </div>
            </div>
        </div>

        <div class="load-section card">
            <input type="file" id="loadFile" accept=".json">
            <button class="btn btn-secondary" onclick="document.getElementById('loadFile').click()">
                Load Existing ValueSet
            </button>
            <span id="loadedFileName" style="color: var(--text-muted); font-size: 0.875rem;"></span>
            <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
        </div>

        <div class="form-column">
            <div class="card">
                <h2>Metadata</h2>

                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" placeholder="e.g., Adverse Reaction Agent" oninput="suggestName()">
                </div>

                <div class="form-group">
                    <label for="name">
                        Name <span class="label-hint">(PascalCase, no spaces)</span>
                        <span id="nameCharCount" class="label-hint"></span>
                    </label>
                    <input type="text" id="name" placeholder="e.g., AdverseReactionAgent" onblur="validateNameField()">
                    <div id="nameValidationWarning" style="display: none; margin-top: 0.25rem;"></div>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" placeholder="Describe what this ValueSet contains and its purpose..."></textarea>
                </div>

                <div class="form-group">
                    <label for="narrativeText">Narrative Text <span class="label-hint">(optional, defaults to description)</span></label>
                    <textarea id="narrativeText" placeholder="Custom text for the narrative div (leave empty to use description)"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="version">Version</label>
                        <input type="text" id="version" value="1.0.0" placeholder="e.g., 1.0.0" onblur="validateNameField()">
                    </div>

                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status">
                            <option value="draft">Draft</option>
                            <option value="active" selected>Active</option>
                            <option value="retired">Retired</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date">
                    </div>

                    <div class="form-group checkbox-group" style="padding-top: 1.5rem;">
                        <input type="checkbox" id="experimental">
                        <label for="experimental" style="margin: 0;">Experimental</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="identifier">Identifier <span class="label-hint">(OID value)</span></label>
                    <div class="identifier-input">
                        <span class="identifier-prefix">urn:oid:</span>
                        <input type="text" id="identifier" placeholder="e.g., 1.2.36.1.2001.1004.201.10036">
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1rem;">
                <h2>Publisher & Copyright</h2>

                <div class="form-group">
                    <label for="publisher">Publisher</label>
                    <select id="publisher">
                        <option value="">-- Select Publisher --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="copyright">Copyright Notices</label>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <select id="copyright" style="flex: 1;">
                            <option value="">-- Select Copyright Notice to Add --</option>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="addCopyrightNotice()" style="white-space: nowrap;">
                            + Add
                        </button>
                    </div>
                    <div id="copyrightList" class="copyright-list"></div>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                        Drag to reorder ‚Ä¢ Click √ó to remove
                    </p>
                </div>
            </div>

            <div class="card" style="margin-top: 1rem;">
                <h2>Compose - Include Blocks</h2>
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">
                    Add one or more include blocks to define the ValueSet contents
                </p>

                <!-- Add Include Interface -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <select id="includeTypeSelect" style="flex: 1;">
                        <option value="">-- Select Include Type --</option>
                        <option value="codeList">Code List (explicit codes)</option>
                        <option value="ecl">SNOMED CT ECL Expression</option>
                        <option value="filter">FHIR Filter</option>
                        <option value="valueSetRef">Reference External ValueSet</option>
                        <option value="entireSystem">Include Entire CodeSystem</option>
                    </select>
                    <button type="button" class="btn btn-secondary" onclick="startAddingInclude()" style="white-space: nowrap;">
                        + Add Include
                    </button>
                </div>

                <!-- Include Blocks List -->
                <div id="includeBlocksList" class="include-blocks-list"></div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                    Drag to reorder ‚Ä¢ Click badge to edit ‚Ä¢ Click √ó to remove
                </p>

                <!-- Hidden radio group for modal use -->
                <div class="radio-group" style="display: none;">
                    <label class="radio-option" onclick="selectComposeType('codeList')">
                        <input type="radio" name="composeType" value="codeList" checked>
                        <span>Code List (explicit codes)</span>
                    </label>
                    <label class="radio-option" onclick="selectComposeType('ecl')">
                        <input type="radio" name="composeType" value="ecl">
                        <span>SNOMED CT ECL Expression</span>
                    </label>
                    <label class="radio-option" onclick="selectComposeType('filter')">
                        <input type="radio" name="composeType" value="filter">
                        <span>FHIR Filter</span>
                    </label>
                    <label class="radio-option" onclick="selectComposeType('valueSetRef')">
                        <input type="radio" name="composeType" value="valueSetRef">
                        <span>Reference External ValueSet</span>
                    </label>
                    <label class="radio-option" onclick="selectComposeType('entireSystem')">
                        <input type="radio" name="composeType" value="entireSystem">
                        <span>Include Entire CodeSystem</span>
                    </label>
                </div>

            </div>
        </div>

        <div class="preview-column">
            <div class="card preview-section">
                <h2>JSON Preview</h2>
                <div id="jsonPreview" class="json-preview">
                    // ValueSet JSON will appear here...
                </div>
                <div class="output-actions">
                    <button class="btn btn-primary" onclick="downloadJSON()">Download JSON</button>
                    <button class="btn btn-secondary" onclick="copyToClipboard()">Copy to Clipboard</button>
                    <button id="validateBtn" class="btn btn-info" onclick="showValidationReport()" aria-label="Validate ValueSet">
                        <span id="validateIcon">‚úì</span> Validate
                        <span id="validationBadge" class="validation-badge" style="display: none;"></span>
                    </button>
                    <button id="diffBtn" class="btn btn-info" onclick="showDiffReport()" aria-label="View differences from loaded file" disabled>
                        üìã View Diff
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Block Editor Modal -->
    <div id="includeEditorModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeIncludeEditor()"></div>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="includeEditorTitle">
            <div class="modal-header">
                <h3 id="includeEditorTitle">Add Include Block</h3>
                <button class="modal-close" onclick="closeIncludeEditor()" aria-label="Close dialog" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="includeEditorContent">
                    <!-- The compose content sections will be shown here -->
                    <div id="modal-compose-codeList" class="compose-content">
                        <div class="form-group">
                            <label for="modalCodeSystem">Code System</label>
                            <select id="modalCodeSystem" class="code-system-select">
                                <option value="http://snomed.info/sct">SNOMED CT (http://snomed.info/sct)</option>
                                <option value="http://loinc.org">LOINC (http://loinc.org)</option>
                                <option value="http://terminology.hl7.org/CodeSystem/data-absent-reason">HL7 Data Absent Reason</option>
                                <option value="custom">Custom System URL...</option>
                            </select>
                            <input type="text" id="modalCustomCodeSystem" placeholder="Enter custom code system URL" style="margin-top: 0.5rem; display: none;">
                        </div>
                        <div class="form-group">
                            <label for="modalCodeListInput">Codes <span class="label-hint">(one per line, or code,display format)</span></label>
                            <textarea id="modalCodeListInput" class="code-list-input" placeholder="281647001&#10;419076005&#10;or&#10;281647001,Adverse reaction&#10;419076005,Allergic reaction"></textarea>
                        </div>
                        <div class="form-group">
                            <input type="file" id="modalCodeListFile" accept=".csv,.txt" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('modalCodeListFile').click()">
                                Upload Code List File
                            </button>
                        </div>
                    </div>

                    <div id="modal-compose-ecl" class="compose-content">
                        <div class="form-group">
                            <label for="modalEclExpression">ECL Expression</label>
                            <textarea id="modalEclExpression" class="code-list-input" placeholder="e.g., < 394658006|Clinical specialty|&#10;or&#10;^ 32570211000036100 |Substance foundation reference set|"></textarea>
                        </div>
                    </div>

                    <div id="modal-compose-filter" class="compose-content">
                        <div class="form-group">
                            <label for="modalFilterSystem">Code System</label>
                            <select id="modalFilterSystem">
                                <option value="http://snomed.info/sct">SNOMED CT (http://snomed.info/sct)</option>
                                <option value="http://loinc.org">LOINC (http://loinc.org)</option>
                                <option value="custom">Custom System URL...</option>
                            </select>
                            <input type="text" id="modalCustomFilterSystem" placeholder="Enter custom code system URL" style="margin-top: 0.5rem; display: none;">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="modalFilterProperty">Property</label>
                                <select id="modalFilterProperty">
                                    <option value="concept">concept</option>
                                    <option value="constraint">constraint</option>
                                    <option value="code">code</option>
                                    <option value="display">display</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="modalFilterOp">Operator</label>
                                <select id="modalFilterOp">
                                    <option value="=">=</option>
                                    <option value="in">in</option>
                                    <option value="not-in">not-in</option>
                                    <option value="is-a">is-a</option>
                                    <option value="descendent-of">descendent-of</option>
                                    <option value="is-not-a">is-not-a</option>
                                    <option value="regex">regex</option>
                                    <option value="exists">exists</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="modalFilterValue">Value</label>
                            <input type="text" id="modalFilterValue" placeholder="e.g., 142341000036103">
                        </div>
                    </div>

                    <div id="modal-compose-valueSetRef" class="compose-content">
                        <div class="form-group">
                            <label for="modalValueSetRefUrl">External ValueSet URL</label>
                            <input type="text" id="modalValueSetRefUrl" placeholder="e.g., http://snomed.info/sct/32506021000036107?fhir_vs=refset/1072351000168102">
                        </div>
                    </div>

                    <div id="modal-compose-entireSystem" class="compose-content">
                        <div class="form-group">
                            <label for="modalEntireSystemUrl">Code System URL</label>
                            <select id="modalEntireSystemSelect">
                                <option value="http://snomed.info/sct">SNOMED CT (http://snomed.info/sct)</option>
                                <option value="http://loinc.org">LOINC (http://loinc.org)</option>
                                <option value="custom">Custom System URL...</option>
                            </select>
                            <input type="text" id="modalEntireSystemUrl" placeholder="Enter code system URL" style="margin-top: 0.5rem; display: none;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeIncludeEditor()">Cancel</button>
                <button class="btn btn-primary" onclick="saveIncludeBlock()">Save Include</button>
            </div>
        </div>
    </div>

    <!-- Validation Report Modal -->
    <div id="validationReportModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeValidationReport()"></div>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="validationReportTitle" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="validationReportTitle">NCTS Validation Report</h3>
                <button class="modal-close" onclick="closeValidationReport()" aria-label="Close dialog" title="Close">&times;</button>
            </div>
            <div class="modal-body" id="validationReportBody">
                <!-- Validation report content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeValidationReport()">Close</button>
                <button class="btn btn-primary" onclick="closeValidationReport(); downloadJSON();">Download Anyway</button>
            </div>
        </div>
    </div>

    <!-- Diff Report Modal -->
    <div id="diffReportModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeDiffReport()"></div>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="diffReportTitle" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="diffReportTitle">Diff: Original vs Current</h3>
                <button class="modal-close" onclick="closeDiffReport()" aria-label="Close dialog" title="Close">&times;</button>
            </div>
            <div class="modal-body" id="diffReportBody">
                <!-- Diff report content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDiffReport()">Close</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Theme handling
        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme(theme);
            updateThemeButtons(theme);
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }

        function updateThemeButtons(theme) {
            document.querySelectorAll('.theme-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`theme-${theme}`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        function initTheme() {
            const saved = localStorage.getItem('theme') || 'system';
            applyTheme(saved);
            updateThemeButtons(saved);
        }

        // Initialize theme immediately to prevent flash
        initTheme();

        // Focus management for modals
        // Find all focusable elements within a container
        function getFocusableElements(container) {
            const focusableSelectors = [
                'button:not([disabled]):not([style*="display:none"])',
                'input:not([disabled]):not([type="hidden"])',
                'textarea:not([disabled])',
                'select:not([disabled])',
                'a[href]',
                '[tabindex]:not([tabindex="-1"])'
            ].join(',');

            return Array.from(container.querySelectorAll(focusableSelectors))
                .filter(element => {
                    // Exclude hidden elements and their children
                    return element.offsetParent !== null &&
                           element.style.display !== 'none' &&
                           getComputedStyle(element).display !== 'none';
                });
        }

        // Create a focus trap object for a modal
        function createFocusTrap(modalElement, modalContentElement, closeCallback) {
            return {
                modalElement: modalElement,
                modalContentElement: modalContentElement,
                closeCallback: closeCallback,
                previouslyFocusedElement: null,
                focusableElements: [],
                boundHandleKeyDown: null,

                // Initialize trap when modal opens
                activate: function(triggerElement) {
                    this.previouslyFocusedElement = triggerElement || document.activeElement;
                    this.focusableElements = getFocusableElements(this.modalContentElement);

                    if (this.focusableElements.length === 0) {
                        console.warn('No focusable elements found in modal');
                        return;
                    }

                    // Set initial focus to first focusable element
                    this.setInitialFocus();

                    // Attach keyboard event listener
                    this.boundHandleKeyDown = this.handleKeyDown.bind(this);
                    document.addEventListener('keydown', this.boundHandleKeyDown);
                },

                // Set focus to first focusable element (prefer form fields)
                setInitialFocus: function() {
                    if (this.focusableElements.length > 0) {
                        // Prefer first input/textarea/select for better UX
                        const preferredElement = this.focusableElements.find(el =>
                            el.tagName === 'INPUT' ||
                            el.tagName === 'TEXTAREA' ||
                            el.tagName === 'SELECT'
                        );

                        if (preferredElement) {
                            preferredElement.focus();
                        } else {
                            this.focusableElements[0].focus();
                        }
                    }
                },

                // Handle Tab/Shift+Tab and Escape key
                handleKeyDown: function(event) {
                    // Only handle if modal is visible
                    if (this.modalElement.style.display === 'none') return;

                    switch(event.key) {
                        case 'Escape':
                            event.preventDefault();
                            if (this.closeCallback) {
                                this.closeCallback();
                            }
                            break;

                        case 'Tab':
                            this.handleTabKey(event);
                            break;
                    }
                },

                // Handle Tab key cycling through focusable elements
                handleTabKey: function(event) {
                    const activeElement = document.activeElement;
                    const focusedIndex = this.focusableElements.indexOf(activeElement);

                    if (event.shiftKey) {
                        // Shift+Tab - move to previous element
                        event.preventDefault();
                        const previousIndex = focusedIndex <= 0 ?
                            this.focusableElements.length - 1 : focusedIndex - 1;
                        this.focusableElements[previousIndex].focus();
                    } else {
                        // Tab - move to next element
                        event.preventDefault();
                        const nextIndex = focusedIndex >= this.focusableElements.length - 1 ?
                            0 : focusedIndex + 1;
                        this.focusableElements[nextIndex].focus();
                    }
                },

                // Deactivate trap when modal closes
                deactivate: function() {
                    if (this.boundHandleKeyDown) {
                        document.removeEventListener('keydown', this.boundHandleKeyDown);
                    }

                    // Return focus to previously focused element
                    if (this.previouslyFocusedElement &&
                        typeof this.previouslyFocusedElement.focus === 'function') {
                        this.previouslyFocusedElement.focus();
                    }

                    this.focusableElements = [];
                    this.previouslyFocusedElement = null;
                }
            };
        }

        // Global focus trap instances
        let includeEditorFocusTrap = null;
        let validationReportFocusTrap = null;
        let diffReportFocusTrap = null;

        // Configuration data
        let publishers = [];
        let copyrights = [];
        let selectedCopyrights = []; // Array of copyright IDs in order

        // Include blocks management
        let includeBlocks = []; // Array of include configuration objects
        let currentEditingIncludeId = null; // ID of include being edited in modal

        // Track unsaved changes
        let hasUnsavedChanges = false;

        // Store original loaded ValueSet for diff comparison
        let originalLoadedValueSet = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            setDefaultDate();
            updatePreview();
            setupEventListeners();
            markFormAsClean(); // Start with no unsaved changes
        });

        async function loadConfig() {
            try {
                const [pubRes, copyRes] = await Promise.all([
                    fetch('config/publishers.json'),
                    fetch('config/copyrights.json')
                ]);

                const pubData = await pubRes.json();
                const copyData = await copyRes.json();

                publishers = pubData.publishers;
                copyrights = copyData.copyrights;

                populatePublishers();
                populateCopyrights();
            } catch (err) {
                console.error('Failed to load config:', err);
                showNotification('Failed to load configuration files', 'error');
            }
        }

        function populatePublishers() {
            const select = document.getElementById('publisher');
            publishers.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                select.appendChild(option);
            });
        }

        function populateCopyrights() {
            const select = document.getElementById('copyright');

            // Group by category
            const byCategory = {
                'base': [],
                'third-party': [],
                'footer': []
            };

            copyrights.forEach(c => {
                const category = c.category || 'third-party';
                if (!byCategory[category]) byCategory[category] = [];
                byCategory[category].push(c);
            });

            // Add optgroups
            if (byCategory.base.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üìÑ Base Copyright Headers';
                byCategory.base.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.name;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }

            if (byCategory['third-party'].length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üè¢ Third-Party Licenses';
                byCategory['third-party'].forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.name;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }

            if (byCategory.footer.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üìå Footer Statements';
                byCategory.footer.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.name;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // Copyright list management
        function addCopyrightNotice() {
            const select = document.getElementById('copyright');
            const copyrightId = select.value;

            if (!copyrightId) {
                showNotification('Please select a copyright notice to add', 'warning');
                return;
            }

            // Check if already added
            if (selectedCopyrights.includes(copyrightId)) {
                showNotification('Copyright notice already added', 'warning');
                return;
            }

            selectedCopyrights.push(copyrightId);
            renderCopyrightList();
            select.value = '';
            updatePreview();
            markFormAsDirty();
        }

        function removeCopyrightNotice(copyrightId) {
            selectedCopyrights = selectedCopyrights.filter(id => id !== copyrightId);
            renderCopyrightList();
            updatePreview();
            markFormAsDirty();
        }

        function moveCopyrightNotice(fromIndex, toIndex) {
            const item = selectedCopyrights[fromIndex];
            selectedCopyrights.splice(fromIndex, 1);
            selectedCopyrights.splice(toIndex, 0, item);
            renderCopyrightList();
            updatePreview();
            markFormAsDirty();
        }

        function moveCopyrightUp(index) {
            if (index > 0) {
                moveCopyrightNotice(index, index - 1);
            }
        }

        function moveCopyrightDown(index) {
            if (index < selectedCopyrights.length - 1) {
                moveCopyrightNotice(index, index + 1);
            }
        }

        function renderCopyrightList() {
            const container = document.getElementById('copyrightList');
            container.innerHTML = '';

            selectedCopyrights.forEach((copyrightId, index) => {
                const copyright = copyrights.find(c => c.id === copyrightId);
                if (!copyright) return;

                const item = document.createElement('div');
                item.className = 'copyright-item';
                item.draggable = true;
                item.dataset.index = index;
                item.dataset.id = copyrightId;

                // Drag handle
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.textContent = '‚ò∞';
                handle.title = 'Drag to reorder';
                handle.setAttribute('aria-label', 'Drag to reorder');

                // Name
                const name = document.createElement('span');
                name.className = 'copyright-item-name';
                name.textContent = copyright.name;

                // Category badge
                const category = document.createElement('span');
                category.className = 'copyright-item-category';
                const categoryLabels = {
                    'base': 'üìÑ',
                    'third-party': 'üè¢',
                    'footer': 'üìå'
                };
                category.textContent = categoryLabels[copyright.category] || 'üìÑ';
                category.title = copyright.category || 'base';

                // Remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-copyright';
                removeBtn.textContent = '√ó';
                removeBtn.title = 'Remove';
                removeBtn.setAttribute('aria-label', 'Remove copyright notice');
                removeBtn.onclick = () => removeCopyrightNotice(copyrightId);

                item.appendChild(handle);

                // Navigation buttons
                const navContainer = document.createElement('div');
                navContainer.className = 'copyright-nav-buttons';

                const moveUpBtn = document.createElement('button');
                moveUpBtn.className = 'move-up-btn';
                moveUpBtn.textContent = '‚Üë';
                moveUpBtn.title = 'Move up';
                moveUpBtn.setAttribute('aria-label', 'Move copyright notice up');
                moveUpBtn.disabled = (index === 0);
                moveUpBtn.onclick = (e) => {
                    e.stopPropagation();
                    moveCopyrightUp(index);
                };

                const moveDownBtn = document.createElement('button');
                moveDownBtn.className = 'move-down-btn';
                moveDownBtn.textContent = '‚Üì';
                moveDownBtn.title = 'Move down';
                moveDownBtn.setAttribute('aria-label', 'Move copyright notice down');
                moveDownBtn.disabled = (index === selectedCopyrights.length - 1);
                moveDownBtn.onclick = (e) => {
                    e.stopPropagation();
                    moveCopyrightDown(index);
                };

                navContainer.appendChild(moveUpBtn);
                navContainer.appendChild(moveDownBtn);
                item.appendChild(navContainer);

                item.appendChild(name);
                item.appendChild(category);
                item.appendChild(removeBtn);

                // Drag events
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);

                container.appendChild(item);
            });
        }

        // Drag and drop handlers
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = e.currentTarget;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const targetElement = e.currentTarget;
            if (targetElement !== draggedElement) {
                targetElement.classList.add('drag-over');
            }

            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetElement = e.currentTarget;
            targetElement.classList.remove('drag-over');

            if (draggedElement !== targetElement) {
                const fromIndex = parseInt(draggedElement.dataset.index);
                const toIndex = parseInt(targetElement.dataset.index);
                moveCopyrightNotice(fromIndex, toIndex);
            }

            return false;
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.copyright-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        // Include block management functions
        function startAddingInclude() {
            const typeSelect = document.getElementById('includeTypeSelect');
            const type = typeSelect.value;

            if (!type) {
                showNotification('Please select an include type', 'warning');
                return;
            }

            currentEditingIncludeId = null;
            openIncludeEditor(type);
            typeSelect.value = '';
        }

        function openIncludeEditor(type, includeId = null) {
            const modal = document.getElementById('includeEditorModal');
            const title = document.getElementById('includeEditorTitle');

            if (includeId) {
                currentEditingIncludeId = includeId;
                const include = includeBlocks.find(i => i.id === includeId);
                title.textContent = `Edit ${getIncludeTypeName(include.type)} Include`;

                // Populate form with existing data
                populateIncludeEditor(include);
            } else {
                currentEditingIncludeId = null;
                title.textContent = `Add ${getIncludeTypeName(type)} Include`;

                // Clear form
                clearIncludeEditorForms();
            }

            // Show the appropriate compose content section
            showModalComposeSection(type);

            modal.style.display = 'flex';

            // Activate focus trap
            if (includeEditorFocusTrap) {
                includeEditorFocusTrap.activate(document.activeElement);
            }
        }

        function showModalComposeSection(type) {
            // Hide all modal compose sections
            document.querySelectorAll('[id^="modal-compose-"]').forEach(el => {
                el.classList.remove('active');
            });

            // Show the selected one
            const section = document.getElementById(`modal-compose-${type}`);
            if (section) {
                section.classList.add('active');
            }
        }

        function closeIncludeEditor() {
            const modal = document.getElementById('includeEditorModal');

            // Deactivate focus trap
            if (includeEditorFocusTrap) {
                includeEditorFocusTrap.deactivate();
            }

            modal.style.display = 'none';
            currentEditingIncludeId = null;
            clearIncludeEditorForms();
        }

        function saveIncludeBlock() {
            // Determine which compose section is active in the modal
            const activeSection = document.querySelector('[id^="modal-compose-"].active');
            if (!activeSection) {
                showNotification('Please select an include type', 'warning');
                return;
            }

            const type = activeSection.id.replace('modal-compose-', '');
            const data = extractIncludeData(type);

            if (!data) {
                showNotification('Please fill in the required fields', 'warning');
                return;
            }

            if (currentEditingIncludeId) {
                // Update existing include
                const index = includeBlocks.findIndex(i => i.id === currentEditingIncludeId);
                includeBlocks[index] = {
                    id: currentEditingIncludeId,
                    type: type,
                    data: data
                };
            } else {
                // Add new include
                includeBlocks.push({
                    id: 'include-' + Date.now(),
                    type: type,
                    data: data
                });
            }

            renderIncludeBlocksList();
            closeIncludeEditor();
            updatePreview();
            markFormAsDirty();
        }

        function extractIncludeData(type) {
            // Extract data from modal form based on type
            switch (type) {
                case 'codeList': {
                    let system = document.getElementById('modalCodeSystem').value;
                    if (system === 'custom') {
                        system = document.getElementById('modalCustomCodeSystem').value;
                    }
                    if (!system) return null;
                    const codes = parseCodeList(document.getElementById('modalCodeListInput').value);
                    return { system, codes };
                }
                case 'ecl': {
                    const expression = document.getElementById('modalEclExpression').value;
                    return expression ? { expression } : null;
                }
                case 'filter': {
                    let system = document.getElementById('modalFilterSystem').value;
                    if (system === 'custom') {
                        system = document.getElementById('modalCustomFilterSystem').value;
                    }
                    if (!system) return null;
                    return {
                        system,
                        property: document.getElementById('modalFilterProperty').value,
                        op: document.getElementById('modalFilterOp').value,
                        value: document.getElementById('modalFilterValue').value
                    };
                }
                case 'valueSetRef': {
                    const url = document.getElementById('modalValueSetRefUrl').value;
                    return url ? { url } : null;
                }
                case 'entireSystem': {
                    let system = document.getElementById('modalEntireSystemSelect').value;
                    if (system === 'custom') {
                        system = document.getElementById('modalEntireSystemUrl').value;
                    }
                    return system ? { system } : null;
                }
            }
            return null;
        }

        function populateIncludeEditor(include) {
            // Populate form fields based on include type and data
            const { type, data } = include;

            switch (type) {
                case 'codeList':
                    setModalCodeSystem(data.system);
                    const codeText = data.codes.map(c =>
                        c.display ? `${c.code},${c.display}` : c.code
                    ).join('\n');
                    document.getElementById('modalCodeListInput').value = codeText;
                    break;
                case 'ecl':
                    document.getElementById('modalEclExpression').value = data.expression;
                    break;
                case 'filter':
                    setModalFilterSystem(data.system);
                    document.getElementById('modalFilterProperty').value = data.property;
                    document.getElementById('modalFilterOp').value = data.op;
                    document.getElementById('modalFilterValue').value = data.value;
                    break;
                case 'valueSetRef':
                    document.getElementById('modalValueSetRefUrl').value = data.url;
                    break;
                case 'entireSystem':
                    setModalEntireSystem(data.system);
                    break;
            }

            showModalComposeSection(type);
        }

        function setModalCodeSystem(system) {
            const select = document.getElementById('modalCodeSystem');
            const options = Array.from(select.options).map(o => o.value);
            if (options.includes(system)) {
                select.value = system;
            } else {
                select.value = 'custom';
                document.getElementById('modalCustomCodeSystem').value = system;
                document.getElementById('modalCustomCodeSystem').style.display = 'block';
            }
        }

        function setModalFilterSystem(system) {
            const select = document.getElementById('modalFilterSystem');
            const options = Array.from(select.options).map(o => o.value);
            if (options.includes(system)) {
                select.value = system;
            } else {
                select.value = 'custom';
                document.getElementById('modalCustomFilterSystem').value = system;
                document.getElementById('modalCustomFilterSystem').style.display = 'block';
            }
        }

        function setModalEntireSystem(system) {
            const select = document.getElementById('modalEntireSystemSelect');
            const options = Array.from(select.options).map(o => o.value);
            if (options.includes(system)) {
                select.value = system;
            } else {
                select.value = 'custom';
                document.getElementById('modalEntireSystemUrl').value = system;
                document.getElementById('modalEntireSystemUrl').style.display = 'block';
            }
        }

        function clearIncludeEditorForms() {
            document.getElementById('modalCodeListInput').value = '';
            document.getElementById('modalEclExpression').value = '';
            document.getElementById('modalFilterProperty').value = 'concept';
            document.getElementById('modalFilterOp').value = '=';
            document.getElementById('modalFilterValue').value = '';
            document.getElementById('modalValueSetRefUrl').value = '';
            document.getElementById('modalCodeSystem').value = 'http://snomed.info/sct';
            document.getElementById('modalFilterSystem').value = 'http://snomed.info/sct';
            document.getElementById('modalEntireSystemSelect').value = 'http://snomed.info/sct';
            document.getElementById('modalCustomCodeSystem').style.display = 'none';
            document.getElementById('modalCustomFilterSystem').style.display = 'none';
            document.getElementById('modalEntireSystemUrl').style.display = 'none';
        }

        function removeIncludeBlock(includeId) {
            includeBlocks = includeBlocks.filter(i => i.id !== includeId);
            renderIncludeBlocksList();
            updatePreview();
            markFormAsDirty();
        }

        function moveIncludeBlock(fromIndex, toIndex) {
            const item = includeBlocks[fromIndex];
            includeBlocks.splice(fromIndex, 1);
            includeBlocks.splice(toIndex, 0, item);
            renderIncludeBlocksList();
            updatePreview();
            markFormAsDirty();
        }

        function moveIncludeBlockUp(index) {
            if (index > 0) {
                moveIncludeBlock(index, index - 1);
            }
        }

        function moveIncludeBlockDown(index) {
            if (index < includeBlocks.length - 1) {
                moveIncludeBlock(index, index + 1);
            }
        }

        function renderIncludeBlocksList() {
            const container = document.getElementById('includeBlocksList');
            container.innerHTML = '';

            includeBlocks.forEach((include, index) => {
                const item = document.createElement('div');
                item.className = 'include-block-item';
                item.draggable = true;
                item.dataset.index = index;
                item.dataset.id = include.id;

                // Drag handle
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.textContent = '‚ò∞';
                handle.title = 'Drag to reorder';
                handle.setAttribute('aria-label', 'Drag to reorder');

                // Content
                const content = document.createElement('div');
                content.className = 'include-block-content';

                const title = document.createElement('div');
                title.className = 'include-block-title';
                title.textContent = getIncludeTypeName(include.type);

                const summary = document.createElement('div');
                summary.className = 'include-block-summary';
                summary.textContent = getIncludeSummary(include);

                content.appendChild(title);
                content.appendChild(summary);

                // Edit badge
                const badge = document.createElement('span');
                badge.className = 'include-block-badge';
                badge.textContent = 'Edit';
                badge.onclick = () => openIncludeEditor(include.type, include.id);

                // Remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-include';
                removeBtn.textContent = '√ó';
                removeBtn.title = 'Remove';
                removeBtn.setAttribute('aria-label', 'Remove include block');
                removeBtn.onclick = () => removeIncludeBlock(include.id);

                item.appendChild(handle);

                // Navigation buttons
                const navContainer = document.createElement('div');
                navContainer.className = 'include-nav-buttons';

                const moveUpBtn = document.createElement('button');
                moveUpBtn.className = 'move-up-btn';
                moveUpBtn.textContent = '‚Üë';
                moveUpBtn.title = 'Move up';
                moveUpBtn.setAttribute('aria-label', 'Move include block up');
                moveUpBtn.disabled = (index === 0);
                moveUpBtn.onclick = (e) => {
                    e.stopPropagation();
                    moveIncludeBlockUp(index);
                };

                const moveDownBtn = document.createElement('button');
                moveDownBtn.className = 'move-down-btn';
                moveDownBtn.textContent = '‚Üì';
                moveDownBtn.title = 'Move down';
                moveDownBtn.setAttribute('aria-label', 'Move include block down');
                moveDownBtn.disabled = (index === includeBlocks.length - 1);
                moveDownBtn.onclick = (e) => {
                    e.stopPropagation();
                    moveIncludeBlockDown(index);
                };

                navContainer.appendChild(moveUpBtn);
                navContainer.appendChild(moveDownBtn);
                item.appendChild(navContainer);

                item.appendChild(content);
                item.appendChild(badge);
                item.appendChild(removeBtn);

                // Drag events
                item.addEventListener('dragstart', handleIncludeDragStart);
                item.addEventListener('dragover', handleIncludeDragOver);
                item.addEventListener('drop', handleIncludeDrop);
                item.addEventListener('dragend', handleIncludeDragEnd);

                container.appendChild(item);
            });
        }

        function getIncludeTypeName(type) {
            const names = {
                codeList: 'Code List',
                ecl: 'SNOMED CT ECL Expression',
                filter: 'FHIR Filter',
                valueSetRef: 'External ValueSet Reference',
                entireSystem: 'Entire CodeSystem'
            };
            return names[type] || type;
        }

        function getIncludeSummary(include) {
            const { type, data } = include;

            switch (type) {
                case 'codeList':
                    return `${data.system} - ${data.codes.length} code(s)`;
                case 'ecl':
                    return `constraint = ${data.expression.substring(0, 50)}${data.expression.length > 50 ? '...' : ''}`;
                case 'filter':
                    return `${data.system} | ${data.property} ${data.op} ${data.value}`;
                case 'valueSetRef':
                    return data.url;
                case 'entireSystem':
                    return data.system;
            }
            return '';
        }

        // Drag handlers for include blocks
        let draggedIncludeElement = null;

        function handleIncludeDragStart(e) {
            draggedIncludeElement = e.currentTarget;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleIncludeDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const targetElement = e.currentTarget;
            if (targetElement !== draggedIncludeElement) {
                targetElement.classList.add('drag-over');
            }

            return false;
        }

        function handleIncludeDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetElement = e.currentTarget;
            targetElement.classList.remove('drag-over');

            if (draggedIncludeElement !== targetElement) {
                const fromIndex = parseInt(draggedIncludeElement.dataset.index);
                const toIndex = parseInt(targetElement.dataset.index);
                moveIncludeBlock(fromIndex, toIndex);
            }

            return false;
        }

        function handleIncludeDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.include-block-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function setupEventListeners() {
            // Initialize focus traps for modals
            const includeModal = document.getElementById('includeEditorModal');
            const includeContent = includeModal.querySelector('[role="dialog"]');
            includeEditorFocusTrap = createFocusTrap(includeModal, includeContent, closeIncludeEditor);

            const validationModal = document.getElementById('validationReportModal');
            const validationContent = validationModal.querySelector('[role="dialog"]');
            validationReportFocusTrap = createFocusTrap(validationModal, validationContent, closeValidationReport);

            const diffModal = document.getElementById('diffReportModal');
            const diffContent = diffModal.querySelector('[role="dialog"]');
            diffReportFocusTrap = createFocusTrap(diffModal, diffContent, closeDiffReport);

            // Warn before leaving page with unsaved changes
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = ''; // Required for Chrome
                }
            });

            // Update preview on any input change and mark form as dirty
            document.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('input', () => {
                    markFormAsDirty();
                    debouncedUpdatePreview();
                });
                el.addEventListener('change', () => {
                    markFormAsDirty();
                    updatePreview();
                });
            });

            // Explicit listeners for key fields to ensure they trigger updates
            const keyFields = ['description', 'narrativeText', 'status', 'experimental', 'date', 'identifier'];
            keyFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', debouncedUpdatePreview);
                    field.addEventListener('change', updatePreview);
                }
            });

            // File upload handlers
            document.getElementById('loadFile').addEventListener('change', loadExistingValueSet);
            document.getElementById('modalCodeListFile').addEventListener('change', loadCodeListFile);

            // Modal custom code system toggles
            document.getElementById('modalCodeSystem').addEventListener('change', (e) => {
                document.getElementById('modalCustomCodeSystem').style.display =
                    e.target.value === 'custom' ? 'block' : 'none';
            });
            document.getElementById('modalFilterSystem').addEventListener('change', (e) => {
                document.getElementById('modalCustomFilterSystem').style.display =
                    e.target.value === 'custom' ? 'block' : 'none';
            });
            document.getElementById('modalEntireSystemSelect').addEventListener('change', (e) => {
                document.getElementById('modalEntireSystemUrl').style.display =
                    e.target.value === 'custom' ? 'block' : 'none';
            });
        }

        // Unsaved changes tracking
        function markFormAsDirty() {
            hasUnsavedChanges = true;
        }

        function markFormAsClean() {
            hasUnsavedChanges = false;
        }

        function suggestName() {
            const title = document.getElementById('title').value;
            const name = title.split(/\s+/).map(word =>
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join('');
            document.getElementById('name').value = name;
            validateNameField();
            updatePreview();
        }

        function validateNameField() {
            const nameInput = document.getElementById('name');
            const name = nameInput.value;
            const version = document.getElementById('version').value;
            const warningDiv = document.getElementById('nameValidationWarning');
            const charCountSpan = document.getElementById('nameCharCount');

            const warnings = [];
            let hasError = false;

            // Clear previous styling
            nameInput.classList.remove('input-error', 'input-warning');

            if (name) {
                // Validate PascalCase format: [A-Z]([A-Za-z0-9_]){0,254}
                const namePattern = /^[A-Z]([A-Za-z0-9_]){0,254}$/;
                if (!namePattern.test(name)) {
                    warnings.push('‚ùå Name must be PascalCase (start with capital, no spaces or special chars except _)');
                    hasError = true;
                    nameInput.classList.add('input-error');
                } else if (name.length > 254) {
                    warnings.push('‚ùå Name must not exceed 254 characters');
                    hasError = true;
                    nameInput.classList.add('input-error');
                }

                // Calculate ID length
                const kebabName = name.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
                const majorVersion = version.split('.')[0];
                const fullVersion = version;

                // ID for latest version
                const currentId = `${kebabName}-${majorVersion}`;
                const currentIdLength = currentId.length;

                // ID for previous version (worst case)
                const futureId = `${kebabName}-${fullVersion}`;
                const futureIdLength = futureId.length;

                // Show character count
                charCountSpan.textContent = `(ID: ${currentIdLength}/64 chars)`;

                // Check length constraints
                if (currentIdLength > 64) {
                    warnings.push(`‚ùå Current ID length (${currentIdLength}) exceeds 64 character limit`);
                    hasError = true;
                    nameInput.classList.add('input-error');
                } else if (futureIdLength > 63) {
                    warnings.push(`‚ö†Ô∏è ID with full version (${futureIdLength} chars) may exceed recommended limit of 63`);
                    nameInput.classList.add('input-warning');
                } else if (currentIdLength > 60) {
                    warnings.push(`‚ö†Ô∏è ID length (${currentIdLength}) exceeds recommended 60 characters for latest versions`);
                    nameInput.classList.add('input-warning');
                }
            } else {
                charCountSpan.textContent = '';
            }

            // Display warnings
            if (warnings.length > 0) {
                warningDiv.innerHTML = warnings.map(w =>
                    `<div class="${hasError ? 'validation-error' : 'validation-warning'}">${w}</div>`
                ).join('');
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }

            debouncedUpdatePreview();
        }

        // Validation Report Functions
        function validateValueSet() {
            const results = {
                errors: [],
                warnings: [],
                info: []
            };

            validateRequiredFields(results);
            validateFormats(results);
            validateBestPractices(results);
            validateCompose(results);
            addInfoChecks(results);

            return results;
        }

        function validateRequiredFields(results) {
            const title = document.getElementById('title').value.trim();
            const name = document.getElementById('name').value.trim();
            const description = document.getElementById('description').value.trim();
            const publisherId = document.getElementById('publisher').value;
            const publisher = publishers.find(p => p.id === publisherId);
            const version = document.getElementById('version').value.trim();
            const date = document.getElementById('date').value;

            if (!title) {
                results.errors.push('Title field is required');
            }
            if (!name) {
                results.errors.push('Name field is required');
            }
            if (!description) {
                results.errors.push('Description field is required');
            }
            if (!publisher) {
                results.errors.push('Publisher must be selected');
            }
            if (!version) {
                results.errors.push('Version field is required');
            }
            if (!date) {
                results.errors.push('Date field is required');
            }
        }

        function validateFormats(results) {
            const name = document.getElementById('name').value.trim();
            const version = document.getElementById('version').value.trim();

            if (name) {
                // Validate PascalCase format
                const namePattern = /^[A-Z]([A-Za-z0-9_]){0,254}$/;
                if (!namePattern.test(name)) {
                    results.errors.push('Name must be PascalCase format: start with capital letter, followed by alphanumeric characters or underscores only (no spaces or special characters)');
                }

                // Validate name length
                if (name.length > 254) {
                    results.errors.push('Name must not exceed 254 characters');
                }

                // Calculate ID lengths
                if (version) {
                    const kebabName = name.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
                    const majorVersion = version.split('.')[0];
                    const currentId = `${kebabName}-${majorVersion}`;
                    const futureId = `${kebabName}-${version}`;

                    // Hard limit check
                    if (currentId.length > 64) {
                        results.errors.push(`ID length (${currentId.length}) exceeds hard limit of 64 characters`);
                    } else {
                        // Recommended limit checks
                        if (futureId.length > 63) {
                            results.warnings.push(`ID with full version (${futureId.length} chars) may exceed recommended limit of 63 characters for previous versions`);
                        } else if (currentId.length > 60) {
                            results.warnings.push(`ID length (${currentId.length}) exceeds recommended 60 characters for latest versions`);
                        }
                    }
                }
            }
        }

        function validateBestPractices(results) {
            const title = document.getElementById('title').value.trim();
            const name = document.getElementById('name').value.trim();
            const status = document.getElementById('status').value;
            const experimental = document.getElementById('experimental').checked;
            const identifier = document.getElementById('identifier').value.trim();

            // Check if name matches PascalCase of title
            if (title && name) {
                const expectedName = title.split(/\s+/).map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ).join('');
                if (name !== expectedName) {
                    results.warnings.push(`Name "${name}" differs from expected PascalCase of title "${expectedName}"`);
                }
            }

            // Check title for special characters
            if (title) {
                if (/[^a-zA-Z0-9\s\-]/.test(title)) {
                    results.warnings.push('Title contains special characters (recommended to use only letters, numbers, spaces, and hyphens)');
                }

                // Check for acronyms (2+ consecutive uppercase letters)
                if (/[A-Z]{2,}/.test(title)) {
                    results.warnings.push('Title may contain acronyms (recommended to avoid abbreviations)');
                }
            }

            // Production readiness checks
            if (status !== 'active') {
                results.warnings.push('Status should be "active" for production resources');
            }
            if (experimental === true) {
                results.warnings.push('Experimental should be false for production resources');
            }

            // Copyright notices
            if (selectedCopyrights.length === 0) {
                results.warnings.push('No copyright notices selected (recommended to include at least one)');
            }

            // Identifier (OID)
            if (!identifier) {
                results.warnings.push('Identifier (OID) not provided (recommended for NCTS resources)');
            }
        }

        function validateCompose(results) {
            if (includeBlocks.length === 0) {
                results.errors.push('At least one include block must be defined in the compose section');
            } else {
                // Validate each include block has required data
                let hasInvalidBlock = false;
                includeBlocks.forEach((block, index) => {
                    const data = block.data || {};

                    if (block.type === 'codeList') {
                        if (!data.system || !data.codes || data.codes.length === 0) {
                            hasInvalidBlock = true;
                        }
                    } else if (block.type === 'ecl') {
                        if (!data.expression) {
                            hasInvalidBlock = true;
                        }
                    } else if (block.type === 'filter') {
                        if (!data.system || !data.property || !data.op || !data.value) {
                            hasInvalidBlock = true;
                        }
                    } else if (block.type === 'valueSetRef') {
                        if (!data.valueSet) {
                            hasInvalidBlock = true;
                        }
                    } else if (block.type === 'entireSystem') {
                        if (!data.system) {
                            hasInvalidBlock = true;
                        }
                    }
                });

                if (hasInvalidBlock) {
                    results.errors.push('One or more include blocks are missing required data');
                }
            }
        }

        function addInfoChecks(results) {
            const title = document.getElementById('title').value.trim();
            const name = document.getElementById('name').value.trim();
            const description = document.getElementById('description').value.trim();
            const publisherId = document.getElementById('publisher').value;
            const publisher = publishers.find(p => p.id === publisherId);
            const version = document.getElementById('version').value.trim();
            const date = document.getElementById('date').value;
            const identifier = document.getElementById('identifier').value.trim();
            const status = document.getElementById('status').value;
            const experimental = document.getElementById('experimental').checked;

            // Add passed checks
            if (title) results.info.push('‚úì Title is provided');
            if (name) {
                const namePattern = /^[A-Z]([A-Za-z0-9_]){0,254}$/;
                if (namePattern.test(name) && name.length <= 254) {
                    results.info.push('‚úì Name conforms to PascalCase format');
                }
            }
            if (description) results.info.push('‚úì Description is provided');
            if (publisher) results.info.push('‚úì Publisher is selected');
            if (version) results.info.push('‚úì Version is provided');
            if (date) results.info.push('‚úì Date is provided');
            if (identifier) results.info.push('‚úì Identifier (OID) is provided');
            if (status === 'active') results.info.push('‚úì Status is set to "active"');
            if (experimental === false) results.info.push('‚úì Experimental is set to false');
            if (selectedCopyrights.length > 0) results.info.push(`‚úì ${selectedCopyrights.length} copyright notice(s) selected`);
            if (includeBlocks.length > 0) results.info.push(`‚úì ${includeBlocks.length} include block(s) defined`);

            // Meta profiles check
            results.info.push('‚úì Meta profiles automatically included');
        }

        function showValidationReport() {
            try {
                console.log('Showing validation report...');
                const results = validateValueSet();
                console.log('Validation results:', results);

                const modal = document.getElementById('validationReportModal');
                const body = document.getElementById('validationReportBody');

                if (!modal) {
                    console.error('Modal element not found!');
                    return;
                }
                if (!body) {
                    console.error('Modal body element not found!');
                    return;
                }

                body.innerHTML = renderValidationReport(results);
                modal.style.display = 'flex';
                console.log('Modal should be visible now');

                // Activate focus trap with delay to allow dynamic content to render
                setTimeout(() => {
                    if (validationReportFocusTrap) {
                        validationReportFocusTrap.activate(document.activeElement);
                    }
                }, 50);
            } catch (err) {
                console.error('Error showing validation report:', err);
                alert('Error showing validation report. Check console for details.');
            }
        }

        function closeValidationReport() {
            const modal = document.getElementById('validationReportModal');

            // Deactivate focus trap
            if (validationReportFocusTrap) {
                validationReportFocusTrap.deactivate();
            }

            modal.style.display = 'none';
        }

        function showDiffReport() {
            // Check if original file was loaded
            if (!originalLoadedValueSet) {
                showNotification('No file loaded to compare against', 'warning');
                return;
            }

            const modal = document.getElementById('diffReportModal');
            const body = document.getElementById('diffReportBody');

            // Generate current ValueSet
            const currentValueSet = generateValueSet();

            // Compare original vs current
            const differences = compareValueSets(originalLoadedValueSet, currentValueSet);

            // Render hybrid view: summary + details + full JSON comparison
            let html = '';

            // Summary section
            html += generateDiffSummary(differences);

            // Field-by-field details (only if there are differences)
            if (differences.modified.length > 0 || differences.added.length > 0 || differences.removed.length > 0) {
                html += renderDiffDetails(differences);

                // Full JSON comparison (collapsed by default)
                html += renderFullJsonComparison(originalLoadedValueSet, currentValueSet);
            } else {
                // No changes - show empty state
                html += `
                    <div class="diff-empty-state">
                        <div class="diff-empty-state-icon">‚úì</div>
                        <p><strong>No differences detected</strong></p>
                        <p style="margin-top: 0.5rem; color: var(--text-muted);">
                            The current form matches the loaded resource exactly.
                        </p>
                    </div>
                `;
            }

            body.innerHTML = html;
            modal.style.display = 'flex';

            // Activate focus trap
            if (diffReportFocusTrap) {
                diffReportFocusTrap.activate();
            }
        }

        function closeDiffReport() {
            const modal = document.getElementById('diffReportModal');

            // Deactivate focus trap
            if (diffReportFocusTrap) {
                diffReportFocusTrap.deactivate();
            }

            modal.style.display = 'none';
        }

        function enableDiffButton() {
            const diffBtn = document.getElementById('diffBtn');
            if (diffBtn) {
                diffBtn.disabled = false;
            }
        }

        function disableDiffButton() {
            const diffBtn = document.getElementById('diffBtn');
            if (diffBtn) {
                diffBtn.disabled = true;
            }
        }

        function renderValidationReport(results) {
            const hasErrors = results.errors.length > 0;
            const hasWarnings = results.warnings.length > 0;
            const totalIssues = results.errors.length + results.warnings.length;

            let summaryClass = 'success';
            let summaryIcon = '‚úì';
            let summaryText = 'All validation checks passed!';

            if (hasErrors) {
                summaryClass = 'has-errors';
                summaryIcon = '‚úó';
                summaryText = `Found ${results.errors.length} error(s) and ${results.warnings.length} warning(s)`;
            } else if (hasWarnings) {
                summaryClass = 'has-warnings';
                summaryIcon = '‚ö†';
                summaryText = `Found ${results.warnings.length} warning(s)`;
            }

            let html = `
                <div class="validation-summary ${summaryClass}">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.5rem; margin-right: 0.5rem;">${summaryIcon}</span>
                        ${summaryText}
                    </div>
                    <div style="color: var(--text-muted);">
                        ${results.info.length} checks passed
                        ${hasErrors ? `, ${results.errors.length} errors` : ''}
                        ${hasWarnings ? `, ${results.warnings.length} warnings` : ''}
                    </div>
                </div>
            `;

            // Errors section
            if (hasErrors) {
                html += `
                    <div class="validation-section">
                        <div class="expandable-section">
                            <div class="section-header error" onclick="toggleSection('errors')">
                                <span class="section-icon" id="errors-icon">‚ñº</span>
                                <span>Errors (${results.errors.length})</span>
                            </div>
                            <div class="section-content" id="errors-content">
                                ${results.errors.map(error => `
                                    <div class="validation-item error">‚úó ${error}</div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Warnings section
            if (hasWarnings) {
                html += `
                    <div class="validation-section">
                        <div class="expandable-section">
                            <div class="section-header warning" onclick="toggleSection('warnings')">
                                <span class="section-icon" id="warnings-icon">‚ñº</span>
                                <span>Warnings (${results.warnings.length})</span>
                            </div>
                            <div class="section-content" id="warnings-content">
                                ${results.warnings.map(warning => `
                                    <div class="validation-item warning">‚ö† ${warning}</div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Passed checks section (collapsed by default)
            if (results.info.length > 0) {
                html += `
                    <div class="validation-section">
                        <div class="expandable-section">
                            <div class="section-header success" onclick="toggleSection('passed')">
                                <span class="section-icon collapsed" id="passed-icon">‚ñº</span>
                                <span>Passed Checks (${results.info.length})</span>
                            </div>
                            <div class="section-content collapsed" id="passed-content">
                                ${results.info.map(info => `
                                    <div class="validation-item info">${info}</div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Note about downloading
            if (hasErrors || hasWarnings) {
                html += `
                    <div class="validation-note">
                        <strong>Note:</strong> You can still download the JSON file, but ${hasErrors ? 'it may not be NCTS compliant' : 'some best practices are not followed'}.
                        ${hasErrors ? ' Please address the errors above for full compliance.' : ''}
                    </div>
                `;
            }

            return html;
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const icon = document.getElementById(`${sectionId}-icon`);

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }

        function updateValidationBadge() {
            const results = validateValueSet();
            const badge = document.getElementById('validationBadge');
            const icon = document.getElementById('validateIcon');
            const validateBtn = document.getElementById('validateBtn');
            const totalIssues = results.errors.length + results.warnings.length;

            if (totalIssues > 0) {
                badge.textContent = totalIssues;
                badge.style.display = 'flex';

                if (results.errors.length > 0) {
                    badge.classList.remove('warning-only');
                    icon.textContent = '‚úó';
                    validateBtn.setAttribute('aria-label', `Validate ValueSet - ${results.errors.length} error${results.errors.length > 1 ? 's' : ''} found`);
                } else {
                    badge.classList.add('warning-only');
                    icon.textContent = '‚ö†';
                    validateBtn.setAttribute('aria-label', `Validate ValueSet - ${results.warnings.length} warning${results.warnings.length > 1 ? 's' : ''} found`);
                }
            } else {
                badge.style.display = 'none';
                icon.textContent = '‚úì';
                validateBtn.setAttribute('aria-label', 'Validate ValueSet - No issues');
            }
        }

        function selectComposeType(type) {
            // Update radio buttons
            document.querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`input[value="${type}"]`).closest('.radio-option').classList.add('selected');
            document.querySelector(`input[value="${type}"]`).checked = true;

            // Show/hide compose content
            document.querySelectorAll('.compose-content').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(`compose-${type}`).classList.add('active');

            updatePreview();
        }

        function generateValueSet() {
            const name = document.getElementById('name').value || 'ExampleValueSet';
            const version = document.getElementById('version').value || '1.0.0';
            const title = document.getElementById('title').value || '';
            const description = document.getElementById('description').value || '';
            const narrativeText = document.getElementById('narrativeText').value || description;
            const status = document.getElementById('status').value;
            const experimental = document.getElementById('experimental').checked;
            const date = document.getElementById('date').value;
            const identifier = document.getElementById('identifier').value;

            // Publisher and copyright
            const publisherId = document.getElementById('publisher').value;
            const publisher = publishers.find(p => p.id === publisherId);

            // Generate derived values
            const kebabName = name.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
            const majorVersion = version.split('.')[0];
            const id = `${kebabName}-${majorVersion}`;
            const url = `https://healthterminologies.gov.au/fhir/ValueSet/${kebabName}-${majorVersion}`;

            // Build copyright from selected notices with " \n\n" separator (per authoring guide)
            let copyrightText = '';
            if (selectedCopyrights.length > 0) {
                const currentYear = new Date().getFullYear();
                const copyrightParagraphs = selectedCopyrights.map(copyrightId => {
                    const copyrightTemplate = copyrights.find(c => c.id === copyrightId);
                    if (!copyrightTemplate) return '';
                    return copyrightTemplate.template
                        .replace(/\{\{year\}\}/g, currentYear)
                        .replace(/\{\{publisher\}\}/g, publisher?.name || '');
                }).filter(text => text.length > 0);

                copyrightText = copyrightParagraphs.join(' \n\n');
            }

            // Build narrative
            const narrativeDiv = `<div xmlns="http://www.w3.org/1999/xhtml"><h2>${title}</h2><tt>${url}</tt><p>${narrativeText}</p></div>`;

            // Build compose section
            const compose = buildCompose();

            const valueSet = {
                resourceType: 'ValueSet',
                id: id,
                meta: {
                    profile: [
                        'http://hl7.org/fhir/StructureDefinition/shareablevalueset',
                        'https://healthterminologies.gov.au/fhir/StructureDefinition/composed-value-set-4'
                    ]
                },
                text: {
                    status: 'generated',
                    div: narrativeDiv
                },
                url: url
            };

            // Add identifier if provided
            if (identifier) {
                valueSet.identifier = [{
                    system: 'urn:ietf:rfc:3986',
                    value: `urn:oid:${identifier}`
                }];
            }

            valueSet.version = version;
            valueSet.name = name;
            valueSet.title = title;
            valueSet.status = status;
            valueSet.experimental = experimental;

            if (date) {
                valueSet.date = date;
            }

            if (publisher) {
                valueSet.publisher = publisher.name;
                valueSet.contact = [{
                    telecom: [{
                        system: publisher.contact.system,
                        value: publisher.contact.value
                    }]
                }];
            }

            valueSet.description = description;

            if (copyrightText) {
                valueSet.copyright = copyrightText;
            }

            valueSet.compose = compose;

            return valueSet;
        }

        function buildCompose() {
            const compose = { include: [] };

            // Build includes from includeBlocks array
            includeBlocks.forEach(includeBlock => {
                const { type, data } = includeBlock;

                switch (type) {
                    case 'codeList': {
                        if (data.codes.length > 0) {
                            compose.include.push({
                                system: data.system,
                                concept: data.codes
                            });
                        } else {
                            compose.include.push({ system: data.system });
                        }
                        break;
                    }
                    case 'ecl': {
                        compose.include.push({
                            system: 'http://snomed.info/sct',
                            filter: [{
                                property: 'constraint',
                                op: '=',
                                value: data.expression
                            }]
                        });
                        break;
                    }
                    case 'filter': {
                        compose.include.push({
                            system: data.system,
                            filter: [{
                                property: data.property,
                                op: data.op,
                                value: data.value
                            }]
                        });
                        break;
                    }
                    case 'valueSetRef': {
                        compose.include.push({
                            valueSet: [data.url]
                        });
                        break;
                    }
                    case 'entireSystem': {
                        compose.include.push({
                            system: data.system
                        });
                        break;
                    }
                }
            });

            return compose;
        }

        function parseCodeList(input) {
            const lines = input.trim().split('\n').filter(line => line.trim());
            return lines.map(line => {
                const parts = line.split(',').map(p => p.trim());
                const concept = { code: parts[0] };
                if (parts[1]) {
                    concept.display = parts[1];
                }
                return concept;
            });
        }

        // Debounce configuration for preview updates
        let updatePreviewTimeoutId = null;
        const PREVIEW_DEBOUNCE_DELAY = 200; // milliseconds

        function debouncedUpdatePreview() {
            // Clear any pending update
            if (updatePreviewTimeoutId !== null) {
                clearTimeout(updatePreviewTimeoutId);
            }

            // Schedule new update
            updatePreviewTimeoutId = setTimeout(() => {
                updatePreview();
                updatePreviewTimeoutId = null;
            }, PREVIEW_DEBOUNCE_DELAY);
        }

        // File size validation
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

        function validateFileSize(file, maxSizeBytes) {
            if (file.size > maxSizeBytes) {
                const maxSizeMB = (maxSizeBytes / (1024 * 1024)).toFixed(0);
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
                showNotification(
                    `File too large (${fileSizeMB}MB). Maximum is ${maxSizeMB}MB`,
                    'error'
                );
                console.error(`File size validation failed: ${file.name} is ${fileSizeMB}MB (max: ${maxSizeMB}MB)`);
                return false;
            }
            return true;
        }

        // Diff comparison functions
        function compareValueSets(original, current) {
            const differences = {
                added: [],
                removed: [],
                modified: []
            };

            function compare(obj1, obj2, path = '') {
                // Get all keys from both objects
                const keys1 = obj1 && typeof obj1 === 'object' ? Object.keys(obj1) : [];
                const keys2 = obj2 && typeof obj2 === 'object' ? Object.keys(obj2) : [];
                const allKeys = new Set([...keys1, ...keys2]);

                allKeys.forEach(key => {
                    const currentPath = path ? `${path}.${key}` : key;
                    const val1 = obj1?.[key];
                    const val2 = obj2?.[key];

                    // Field exists in current but not in original (added)
                    if (val1 === undefined && val2 !== undefined) {
                        differences.added.push({
                            path: currentPath,
                            value: val2
                        });
                    }
                    // Field exists in original but not in current (removed)
                    else if (val1 !== undefined && val2 === undefined) {
                        differences.removed.push({
                            path: currentPath,
                            value: val1
                        });
                    }
                    // Both exist, check if they're different
                    else if (val1 !== undefined && val2 !== undefined) {
                        // Handle arrays
                        if (Array.isArray(val1) && Array.isArray(val2)) {
                            const json1 = JSON.stringify(val1);
                            const json2 = JSON.stringify(val2);
                            if (json1 !== json2) {
                                differences.modified.push({
                                    path: currentPath,
                                    oldValue: val1,
                                    newValue: val2,
                                    isArray: true
                                });
                            }
                        }
                        // Handle objects (recurse)
                        else if (typeof val1 === 'object' && val1 !== null &&
                                 typeof val2 === 'object' && val2 !== null &&
                                 !Array.isArray(val1) && !Array.isArray(val2)) {
                            compare(val1, val2, currentPath);
                        }
                        // Handle primitives
                        else if (val1 !== val2) {
                            differences.modified.push({
                                path: currentPath,
                                oldValue: val1,
                                newValue: val2
                            });
                        }
                    }
                });
            }

            compare(original, current);
            return differences;
        }

        function formatPath(path) {
            // Convert dot notation to readable format
            // Example: "compose.include[0].system" ‚Üí "Compose > Include[0] > System"
            return path
                .split('.')
                .map(part => {
                    // Capitalize first letter
                    return part.charAt(0).toUpperCase() + part.slice(1);
                })
                .join(' > ');
        }

        function formatValue(value, maxLength = 200) {
            if (value === null) {
                return 'null';
            }
            if (value === undefined) {
                return 'undefined';
            }
            if (typeof value === 'object') {
                const json = JSON.stringify(value, null, 2);
                if (json.length > maxLength) {
                    return json.substring(0, maxLength) + '...';
                }
                return json;
            }
            const str = String(value);
            if (str.length > maxLength) {
                return str.substring(0, maxLength) + '...';
            }
            return str;
        }

        // Diff rendering functions
        function generateDiffSummary(differences) {
            const modifiedCount = differences.modified.length;
            const addedCount = differences.added.length;
            const removedCount = differences.removed.length;
            const totalChanges = modifiedCount + addedCount + removedCount;

            if (totalChanges === 0) {
                return `
                    <div class="diff-summary">
                        <strong>No differences detected</strong>
                        <p style="margin-top: 0.5rem; color: var(--text-muted);">
                            The current form matches the loaded resource.
                        </p>
                    </div>
                `;
            }

            return `
                <div class="diff-summary">
                    <strong>${totalChanges} change${totalChanges !== 1 ? 's' : ''} detected</strong>
                    <div class="diff-summary-counts">
                        ${modifiedCount > 0 ? `
                            <div class="diff-count diff-count-modified">
                                <span>‚ö†</span>
                                <span>${modifiedCount} modified</span>
                            </div>
                        ` : ''}
                        ${addedCount > 0 ? `
                            <div class="diff-count diff-count-added">
                                <span>+</span>
                                <span>${addedCount} added</span>
                            </div>
                        ` : ''}
                        ${removedCount > 0 ? `
                            <div class="diff-count diff-count-removed">
                                <span>-</span>
                                <span>${removedCount} removed</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderDiffDetails(differences) {
            const { modified, added, removed } = differences;
            let html = '';

            // Modified section
            if (modified.length > 0) {
                html += `
                    <div class="diff-section">
                        <div class="diff-section-header" onclick="toggleDiffSection('modified')">
                            <span class="diff-section-icon" id="modified-icon">‚ñº</span>
                            <span>‚ö† Modified Fields (${modified.length})</span>
                        </div>
                        <div class="diff-section-content" id="modified-content">
                            ${modified.map(item => `
                                <div class="diff-item diff-item-modified">
                                    <div class="diff-path">${formatPath(item.path)}</div>
                                    <div class="diff-value-old">
                                        <div class="diff-value-label">Original</div>
                                        <div class="diff-value">${formatValue(item.oldValue)}</div>
                                    </div>
                                    <div class="diff-value-new">
                                        <div class="diff-value-label">Current</div>
                                        <div class="diff-value">${formatValue(item.newValue)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Added section
            if (added.length > 0) {
                html += `
                    <div class="diff-section">
                        <div class="diff-section-header" onclick="toggleDiffSection('added')">
                            <span class="diff-section-icon" id="added-icon">‚ñº</span>
                            <span>+ Added Fields (${added.length})</span>
                        </div>
                        <div class="diff-section-content" id="added-content">
                            ${added.map(item => `
                                <div class="diff-item diff-item-added">
                                    <div class="diff-path">${formatPath(item.path)}</div>
                                    <div class="diff-value-new">
                                        <div class="diff-value-label">New Value</div>
                                        <div class="diff-value">${formatValue(item.value)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Removed section
            if (removed.length > 0) {
                html += `
                    <div class="diff-section">
                        <div class="diff-section-header" onclick="toggleDiffSection('removed')">
                            <span class="diff-section-icon" id="removed-icon">‚ñº</span>
                            <span>- Removed Fields (${removed.length})</span>
                        </div>
                        <div class="diff-section-content" id="removed-content">
                            ${removed.map(item => `
                                <div class="diff-item diff-item-removed">
                                    <div class="diff-path">${formatPath(item.path)}</div>
                                    <div class="diff-value-old">
                                        <div class="diff-value-label">Original Value</div>
                                        <div class="diff-value">${formatValue(item.value)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        function renderFullJsonComparison(original, current) {
            const originalJson = JSON.stringify(original, null, 2);
            const currentJson = JSON.stringify(current, null, 2);

            return `
                <div class="diff-json-comparison">
                    <div class="diff-section">
                        <div class="diff-section-header" onclick="toggleDiffSection('json-comparison')">
                            <span class="diff-section-icon collapsed" id="json-comparison-icon">‚ñº</span>
                            <span>Full JSON Comparison</span>
                        </div>
                        <div class="diff-section-content collapsed" id="json-comparison-content">
                            <div class="diff-json-panes">
                                <div class="diff-json-pane">
                                    <div class="diff-json-pane-header">Original JSON</div>
                                    <div class="diff-json-pane-content">${syntaxHighlight(originalJson)}</div>
                                </div>
                                <div class="diff-json-pane">
                                    <div class="diff-json-pane-header">Current JSON</div>
                                    <div class="diff-json-pane-content">${syntaxHighlight(currentJson)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleDiffSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const icon = document.getElementById(`${sectionId}-icon`);

            if (content && icon) {
                content.classList.toggle('collapsed');
                icon.classList.toggle('collapsed');
            }
        }

        function updatePreview() {
            const valueSet = generateValueSet();
            const json = JSON.stringify(valueSet, null, 2);
            document.getElementById('jsonPreview').innerHTML = syntaxHighlight(json);

            // Update validation badge - wrapped in try-catch to prevent blocking preview updates
            try {
                updateValidationBadge();
            } catch (err) {
                console.error('Validation badge update failed:', err);
            }
        }

        function syntaxHighlight(json) {
            return json
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    }
                    return `<span class="${cls}">${match}</span>`;
                });
        }

        function downloadJSON() {
            const valueSet = generateValueSet();
            const json = JSON.stringify(valueSet, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ValueSet-${valueSet.name}-${valueSet.version}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('ValueSet downloaded successfully!');
            markFormAsClean(); // Clear unsaved changes flag after successful download
        }

        function copyToClipboard() {
            const valueSet = generateValueSet();
            const json = JSON.stringify(valueSet, null, 2);

            if (!navigator.clipboard) {
                showNotification('Clipboard API not available (requires HTTPS or localhost)', 'error');
                console.error('Clipboard API not available in this context');
                return;
            }

            navigator.clipboard.writeText(json).then(() => {
                showNotification('Copied to clipboard!');
            }).catch((err) => {
                showNotification('Failed to copy to clipboard', 'error');
                console.error('Clipboard error:', err);
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            if (type === 'error') {
                notification.style.background = 'var(--error)';
            } else if (type === 'warning') {
                notification.style.background = 'var(--warning)';
            } else {
                notification.style.background = 'var(--success)';
            }
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        async function loadExistingValueSet(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!validateFileSize(file, MAX_FILE_SIZE)) {
                event.target.value = '';
                return;
            }

            try {
                const text = await file.text();
                const valueSet = JSON.parse(text);

                // Store original for diff comparison (deep clone)
                originalLoadedValueSet = JSON.parse(JSON.stringify(valueSet));

                populateFormFromValueSet(valueSet);
                document.getElementById('loadedFileName').textContent = `Loaded: ${file.name}`;

                // Validate loaded resource and show warnings (but don't change values)
                const violations = validateLoadedResource(valueSet);
                if (violations.length > 0) {
                    const violationMsg = 'ValueSet loaded with validation warnings:\n' + violations.join('\n');
                    console.warn(violationMsg);
                    showNotification('ValueSet loaded - See validation warnings below', 'warning');
                } else {
                    showNotification('ValueSet loaded! Update version and date as needed.');
                }

                // Highlight version field
                document.getElementById('version').classList.add('version-highlight');

                // Trigger validation to show warnings
                validateNameField();

                // Clear unsaved changes flag after loading file
                markFormAsClean();

                // Enable diff button since we now have an original to compare against
                enableDiffButton();

            } catch (err) {
                showNotification('Failed to parse JSON file', 'error');
                console.error(err);
            }

            event.target.value = '';
        }

        function validateLoadedResource(vs) {
            const violations = [];

            // Validate name format
            if (vs.name) {
                const namePattern = /^[A-Z]([A-Za-z0-9_]){0,254}$/;
                if (!namePattern.test(vs.name)) {
                    violations.push(`‚ö†Ô∏è Name "${vs.name}" does not conform to PascalCase format`);
                }
                if (vs.name.length > 254) {
                    violations.push(`‚ö†Ô∏è Name length (${vs.name.length}) exceeds 254 character limit`);
                }
            }

            // Validate ID length
            if (vs.id) {
                if (vs.id.length > 64) {
                    violations.push(`‚ö†Ô∏è ID length (${vs.id.length}) exceeds 64 character limit`);
                }
            }

            // Check if name matches title (PascalCase)
            if (vs.title && vs.name) {
                const expectedName = vs.title.split(/\s+/).map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ).join('');
                if (vs.name !== expectedName) {
                    violations.push(`‚ÑπÔ∏è Name "${vs.name}" differs from expected PascalCase of title "${expectedName}"`);
                }
            }

            return violations;
        }

        function populateFormFromValueSet(vs) {
            // Basic metadata
            document.getElementById('title').value = vs.title || '';
            document.getElementById('name').value = vs.name || '';
            document.getElementById('description').value = vs.description || '';
            document.getElementById('version').value = vs.version || '1.0.0';
            document.getElementById('status').value = vs.status || 'active';
            document.getElementById('experimental').checked = vs.experimental === true;

            // Set date to today for new version
            setDefaultDate();

            // Narrative text
            if (vs.text?.div) {
                // Extract text from div
                const match = vs.text.div.match(/<p>(.*?)<\/p>/);
                if (match) {
                    document.getElementById('narrativeText').value = match[1];
                }
            }

            // Identifier
            if (vs.identifier?.[0]?.value) {
                const oid = vs.identifier[0].value.replace('urn:oid:', '');
                document.getElementById('identifier').value = oid;
            }

            // Publisher - try to match
            if (vs.publisher) {
                const matchedPub = publishers.find(p => p.name === vs.publisher);
                if (matchedPub) {
                    document.getElementById('publisher').value = matchedPub.id;
                }
            }

            // Copyright - parse and match paragraphs to templates
            selectedCopyrights = [];
            if (vs.copyright) {
                // Split by " \n\n" (authoring guide separator)
                const paragraphs = vs.copyright.split(' \n\n');

                paragraphs.forEach(paragraph => {
                    const trimmed = paragraph.trim();
                    if (!trimmed) return;

                    // Try to match paragraph to a template
                    const matched = copyrights.find(c => {
                        // Remove year and publisher placeholders for matching
                        const template = c.template
                            .replace(/\{\{year\}\}/g, '\\d{4}')
                            .replace(/\{\{publisher\}\}/g, '.+?');

                        // Create regex pattern (escape special chars except our placeholders)
                        const pattern = template
                            .replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
                            .replace(/\\\\d\{4\}/g, '\\d{4}')
                            .replace(/\\\.\+\?/g, '.+?');

                        try {
                            const regex = new RegExp(pattern.substring(0, 100)); // Match first 100 chars for performance
                            return regex.test(trimmed.substring(0, 100));
                        } catch (e) {
                            // Fallback to simple string matching
                            return trimmed.includes(c.template.substring(0, 50).replace(/\{\{year\}\}/g, '').replace(/\{\{publisher\}\}/g, ''));
                        }
                    });

                    if (matched && !selectedCopyrights.includes(matched.id)) {
                        selectedCopyrights.push(matched.id);
                    }
                });

                renderCopyrightList();
            }

            // Compose section - load ALL includes
            includeBlocks = [];
            if (vs.compose?.include) {
                vs.compose.include.forEach(inc => {
                    let type, data;

                    if (inc.valueSet) {
                        // External ValueSet reference
                        type = 'valueSetRef';
                        data = { url: inc.valueSet[0] || '' };
                    } else if (inc.filter) {
                        const filter = inc.filter[0];
                        if (filter.property === 'constraint') {
                            // ECL expression
                            type = 'ecl';
                            data = { expression: filter.value || '' };
                        } else {
                            // Generic filter
                            type = 'filter';
                            data = {
                                system: inc.system,
                                property: filter.property || 'concept',
                                op: filter.op || '=',
                                value: filter.value || ''
                            };
                        }
                    } else if (inc.concept) {
                        // Code list
                        type = 'codeList';
                        data = {
                            system: inc.system,
                            codes: inc.concept
                        };
                    } else if (inc.system) {
                        // Entire system
                        type = 'entireSystem';
                        data = { system: inc.system };
                    }

                    if (type && data) {
                        includeBlocks.push({
                            id: 'include-' + Date.now() + '-' + includeBlocks.length,
                            type: type,
                            data: data
                        });
                    }
                });

                renderIncludeBlocksList();
            }

            updatePreview();
        }

        function setCodeSystem(system) {
            const select = document.getElementById('codeSystem');
            const options = Array.from(select.options).map(o => o.value);
            if (options.includes(system)) {
                select.value = system;
            } else {
                select.value = 'custom';
                document.getElementById('customCodeSystem').value = system;
                document.getElementById('customCodeSystem').style.display = 'block';
            }
        }

        function setFilterSystem(system) {
            const select = document.getElementById('filterSystem');
            const options = Array.from(select.options).map(o => o.value);
            if (options.includes(system)) {
                select.value = system;
            } else {
                select.value = 'custom';
                document.getElementById('customFilterSystem').value = system;
                document.getElementById('customFilterSystem').style.display = 'block';
            }
        }

        function setEntireSystem(system) {
            const select = document.getElementById('entireSystemSelect');
            const options = Array.from(select.options).map(o => o.value);
            if (options.includes(system)) {
                select.value = system;
            } else {
                select.value = 'custom';
                document.getElementById('entireSystemUrl').value = system;
                document.getElementById('entireSystemUrl').style.display = 'block';
            }
        }

        async function loadCodeListFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!validateFileSize(file, MAX_FILE_SIZE)) {
                event.target.value = '';
                return;
            }

            try {
                const text = await file.text();

                // Validate content is not empty/whitespace-only
                if (!text.trim()) {
                    showNotification('File is empty', 'error');
                    console.error('Attempted to load empty code list file:', file.name);
                    event.target.value = '';
                    return;
                }

                // Load content into textarea
                document.getElementById('modalCodeListInput').value = text;

                // Parse to get code count for user feedback
                const codes = parseCodeList(text);
                const codeCount = codes.length;

                // Provide informative success message
                showNotification(`Code list loaded: ${file.name} (${codeCount} code${codeCount !== 1 ? 's' : ''})`);

            } catch (err) {
                showNotification('Failed to read file', 'error');
                console.error('Error loading code list file:', file.name, err);
            }

            event.target.value = '';
        }

        function clearForm() {
            document.getElementById('title').value = '';
            document.getElementById('name').value = '';
            document.getElementById('description').value = '';
            document.getElementById('narrativeText').value = '';
            document.getElementById('version').value = '1.0.0';
            document.getElementById('status').value = 'active';
            document.getElementById('experimental').checked = false;
            document.getElementById('identifier').value = '';
            document.getElementById('publisher').value = '';
            document.getElementById('copyright').value = '';
            selectedCopyrights = [];
            renderCopyrightList();

            // Clear include blocks
            includeBlocks = [];
            renderIncludeBlocksList();
            clearIncludeEditorForms();
            document.getElementById('includeTypeSelect').value = '';

            document.getElementById('loadedFileName').textContent = '';
            document.getElementById('version').classList.remove('version-highlight');

            setDefaultDate();
            updatePreview();
            showNotification('Form cleared');

            // Clear original loaded ValueSet
            originalLoadedValueSet = null;

            // Disable diff button since there's no original to compare against
            disableDiffButton();

            markFormAsClean(); // Clear unsaved changes flag after clearing form
        }
    </script>
</body>
</html>
