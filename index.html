<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR ValueSet Creator</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --input-bg: #ffffff;
            --json-bg: #1e293b;
            --json-text: #e2e8f0;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --input-bg: #0f172a;
            --json-bg: #020617;
            --json-text: #e2e8f0;
        }

        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --primary: #3b82f6;
                --primary-dark: #2563eb;
                --bg: #0f172a;
                --card-bg: #1e293b;
                --text: #f1f5f9;
                --text-muted: #94a3b8;
                --border: #334155;
                --input-bg: #0f172a;
                --json-bg: #020617;
                --json-text: #e2e8f0;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        h1 {
            grid-column: 1 / -1;
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            grid-column: 1 / -1;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .label-hint {
            font-weight: normal;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        input[type="text"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.875rem;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text);
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input {
            width: auto;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .load-section {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .load-section input[type="file"] {
            display: none;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
        }

        .radio-option:hover {
            background: var(--bg);
        }

        .radio-option.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .radio-option input {
            margin: 0;
        }

        .compose-content {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg);
            border-radius: 4px;
            display: none;
        }

        .compose-content.active {
            display: block;
        }

        .code-list-input {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            min-height: 150px;
        }

        .preview-section {
            position: sticky;
            top: 2rem;
        }

        .json-preview {
            background: var(--json-bg);
            color: var(--json-text);
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .json-key { color: #7dd3fc; }
        .json-string { color: #86efac; }
        .json-number { color: #fcd34d; }
        .json-boolean { color: #f472b6; }

        .output-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 4px;
            background: var(--success);
            color: white;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .identifier-input {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .identifier-prefix {
            color: var(--text-muted);
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .version-highlight {
            border-color: var(--warning) !important;
            background: rgba(245, 158, 11, 0.1);
        }

        .validation-error {
            color: var(--error);
            font-size: 0.75rem;
        }

        .validation-warning {
            color: var(--warning);
            font-size: 0.75rem;
        }

        .validation-info {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .input-error {
            border-color: var(--error) !important;
        }

        .input-warning {
            border-color: var(--warning) !important;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .code-system-select {
            margin-bottom: 0.5rem;
        }

        .header-row {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .theme-toggle button {
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .theme-toggle button:hover {
            background: var(--border);
        }

        .theme-toggle button.active {
            background: var(--primary);
            color: white;
        }

        .copyright-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 40px;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 4px;
            border: 1px dashed var(--border);
        }

        .copyright-list:empty::before {
            content: "No copyright notices added yet";
            color: var(--text-muted);
            font-size: 0.875rem;
            text-align: center;
            display: block;
            padding: 0.5rem;
        }

        .copyright-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: move;
            transition: all 0.2s;
        }

        .copyright-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .copyright-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .copyright-item.drag-over {
            border-top: 2px solid var(--primary);
        }

        .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            font-size: 1.2rem;
            padding: 0 0.25rem;
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .copyright-item-name {
            flex: 1;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .copyright-item-category {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.125rem 0.5rem;
            background: var(--bg);
            border-radius: 3px;
        }

        .remove-copyright {
            background: none;
            border: none;
            color: var(--error);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            transition: all 0.2s;
        }

        .remove-copyright:hover {
            color: var(--primary-dark);
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <div class="header-title">
                <h1 style="margin-bottom: 0;">FHIR ValueSet Creator</h1>
                <p class="subtitle" style="margin-bottom: 0;">Create FHIR R4 ValueSet resources for download</p>
            </div>
            <div class="header-actions">
                <a href="https://github.com/MattCordell/Stoker/issues/new" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">
                    üêõ Report Bug
                </a>
                <div class="theme-toggle">
                    <button id="theme-system" onclick="setTheme('system')" title="System">Auto</button>
                    <button id="theme-light" onclick="setTheme('light')" title="Light">‚òÄÔ∏è</button>
                    <button id="theme-dark" onclick="setTheme('dark')" title="Dark">üåô</button>
                </div>
            </div>
        </div>

        <div class="load-section card">
            <input type="file" id="loadFile" accept=".json">
            <button class="btn btn-secondary" onclick="document.getElementById('loadFile').click()">
                Load Existing ValueSet
            </button>
            <span id="loadedFileName" style="color: var(--text-muted); font-size: 0.875rem;"></span>
            <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
        </div>

        <div class="form-column">
            <div class="card">
                <h2>Metadata</h2>

                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" placeholder="e.g., Adverse Reaction Agent" oninput="suggestName()">
                </div>

                <div class="form-group">
                    <label for="name">
                        Name <span class="label-hint">(PascalCase, no spaces)</span>
                        <span id="nameCharCount" class="label-hint"></span>
                    </label>
                    <input type="text" id="name" placeholder="e.g., AdverseReactionAgent" oninput="validateNameField()">
                    <div id="nameValidationWarning" style="display: none; margin-top: 0.25rem;"></div>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" placeholder="Describe what this ValueSet contains and its purpose..."></textarea>
                </div>

                <div class="form-group">
                    <label for="narrativeText">Narrative Text <span class="label-hint">(optional, defaults to description)</span></label>
                    <textarea id="narrativeText" placeholder="Custom text for the narrative div (leave empty to use description)"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="version">Version</label>
                        <input type="text" id="version" value="1.0.0" placeholder="e.g., 1.0.0" oninput="validateNameField()">
                    </div>

                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status">
                            <option value="draft">Draft</option>
                            <option value="active" selected>Active</option>
                            <option value="retired">Retired</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date">
                    </div>

                    <div class="form-group checkbox-group" style="padding-top: 1.5rem;">
                        <input type="checkbox" id="experimental">
                        <label for="experimental" style="margin: 0;">Experimental</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="identifier">Identifier <span class="label-hint">(OID value)</span></label>
                    <div class="identifier-input">
                        <span class="identifier-prefix">urn:oid:</span>
                        <input type="text" id="identifier" placeholder="e.g., 1.2.36.1.2001.1004.201.10036">
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1rem;">
                <h2>Publisher & Copyright</h2>

                <div class="form-group">
                    <label for="publisher">Publisher</label>
                    <select id="publisher">
                        <option value="">-- Select Publisher --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="copyright">Copyright Notices</label>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <select id="copyright" style="flex: 1;">
                            <option value="">-- Select Copyright Notice to Add --</option>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="addCopyrightNotice()" style="white-space: nowrap;">
                            + Add
                        </button>
                    </div>
                    <div id="copyrightList" class="copyright-list"></div>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                        Drag to reorder ‚Ä¢ Click √ó to remove
                    </p>
                </div>
            </div>

            <div class="card" style="margin-top: 1rem;">
                <h2>Compose</h2>
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">
                    Choose how to define the contents of this ValueSet
                </p>

                <div class="radio-group">
                    <label class="radio-option" onclick="selectComposeType('codeList')">
                        <input type="radio" name="composeType" value="codeList" checked>
                        <span>Code List (explicit codes)</span>
                    </label>
                    <label class="radio-option" onclick="selectComposeType('ecl')">
                        <input type="radio" name="composeType" value="ecl">
                        <span>SNOMED CT ECL Expression</span>
                    </label>
                    <label class="radio-option" onclick="selectComposeType('filter')">
                        <input type="radio" name="composeType" value="filter">
                        <span>FHIR Filter</span>
                    </label>
                    <label class="radio-option" onclick="selectComposeType('valueSetRef')">
                        <input type="radio" name="composeType" value="valueSetRef">
                        <span>Reference External ValueSet</span>
                    </label>
                    <label class="radio-option" onclick="selectComposeType('entireSystem')">
                        <input type="radio" name="composeType" value="entireSystem">
                        <span>Include Entire CodeSystem</span>
                    </label>
                </div>

                <div id="compose-codeList" class="compose-content active">
                    <div class="form-group">
                        <label for="codeSystem">Code System</label>
                        <select id="codeSystem" class="code-system-select">
                            <option value="http://snomed.info/sct">SNOMED CT (http://snomed.info/sct)</option>
                            <option value="http://loinc.org">LOINC (http://loinc.org)</option>
                            <option value="http://terminology.hl7.org/CodeSystem/data-absent-reason">HL7 Data Absent Reason</option>
                            <option value="custom">Custom System URL...</option>
                        </select>
                        <input type="text" id="customCodeSystem" placeholder="Enter custom code system URL" style="margin-top: 0.5rem; display: none;">
                    </div>
                    <div class="form-group">
                        <label for="codeListInput">Codes <span class="label-hint">(one per line, or code,display format)</span></label>
                        <textarea id="codeListInput" class="code-list-input" placeholder="281647001&#10;419076005&#10;or&#10;281647001,Adverse reaction&#10;419076005,Allergic reaction"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="file" id="codeListFile" accept=".csv,.txt" style="display: none;">
                        <button class="btn btn-secondary" onclick="document.getElementById('codeListFile').click()">
                            Upload Code List File
                        </button>
                    </div>
                </div>

                <div id="compose-ecl" class="compose-content">
                    <div class="form-group">
                        <label for="eclExpression">ECL Expression</label>
                        <textarea id="eclExpression" class="code-list-input" placeholder="e.g., < 394658006|Clinical specialty|&#10;or&#10;^ 32570211000036100 |Substance foundation reference set|"></textarea>
                    </div>
                </div>

                <div id="compose-filter" class="compose-content">
                    <div class="form-group">
                        <label for="filterSystem">Code System</label>
                        <select id="filterSystem">
                            <option value="http://snomed.info/sct">SNOMED CT (http://snomed.info/sct)</option>
                            <option value="http://loinc.org">LOINC (http://loinc.org)</option>
                            <option value="custom">Custom System URL...</option>
                        </select>
                        <input type="text" id="customFilterSystem" placeholder="Enter custom code system URL" style="margin-top: 0.5rem; display: none;">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filterProperty">Property</label>
                            <select id="filterProperty">
                                <option value="concept">concept</option>
                                <option value="constraint">constraint</option>
                                <option value="code">code</option>
                                <option value="display">display</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterOp">Operator</label>
                            <select id="filterOp">
                                <option value="=">=</option>
                                <option value="in">in</option>
                                <option value="not-in">not-in</option>
                                <option value="is-a">is-a</option>
                                <option value="descendent-of">descendent-of</option>
                                <option value="is-not-a">is-not-a</option>
                                <option value="regex">regex</option>
                                <option value="exists">exists</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="filterValue">Value</label>
                        <input type="text" id="filterValue" placeholder="e.g., 142341000036103">
                    </div>
                </div>

                <div id="compose-valueSetRef" class="compose-content">
                    <div class="form-group">
                        <label for="valueSetRefUrl">External ValueSet URL</label>
                        <input type="text" id="valueSetRefUrl" placeholder="e.g., http://snomed.info/sct/32506021000036107?fhir_vs=refset/1072351000168102">
                    </div>
                </div>

                <div id="compose-entireSystem" class="compose-content">
                    <div class="form-group">
                        <label for="entireSystemUrl">Code System URL</label>
                        <select id="entireSystemSelect">
                            <option value="http://snomed.info/sct">SNOMED CT (http://snomed.info/sct)</option>
                            <option value="http://loinc.org">LOINC (http://loinc.org)</option>
                            <option value="custom">Custom System URL...</option>
                        </select>
                        <input type="text" id="entireSystemUrl" placeholder="Enter code system URL" style="margin-top: 0.5rem; display: none;">
                    </div>
                </div>
            </div>
        </div>

        <div class="preview-column">
            <div class="card preview-section">
                <h2>JSON Preview</h2>
                <div id="jsonPreview" class="json-preview">
                    // ValueSet JSON will appear here...
                </div>
                <div class="output-actions">
                    <button class="btn btn-primary" onclick="downloadJSON()">Download JSON</button>
                    <button class="btn btn-secondary" onclick="copyToClipboard()">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Theme handling
        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme(theme);
            updateThemeButtons(theme);
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }

        function updateThemeButtons(theme) {
            document.querySelectorAll('.theme-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`theme-${theme}`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        function initTheme() {
            const saved = localStorage.getItem('theme') || 'system';
            applyTheme(saved);
            updateThemeButtons(saved);
        }

        // Initialize theme immediately to prevent flash
        initTheme();

        // Configuration data
        let publishers = [];
        let copyrights = [];
        let selectedCopyrights = []; // Array of copyright IDs in order

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            setDefaultDate();
            updatePreview();
            setupEventListeners();
        });

        async function loadConfig() {
            try {
                const [pubRes, copyRes] = await Promise.all([
                    fetch('config/publishers.json'),
                    fetch('config/copyrights.json')
                ]);

                const pubData = await pubRes.json();
                const copyData = await copyRes.json();

                publishers = pubData.publishers;
                copyrights = copyData.copyrights;

                populatePublishers();
                populateCopyrights();
            } catch (err) {
                console.error('Failed to load config:', err);
                showNotification('Failed to load configuration files', 'error');
            }
        }

        function populatePublishers() {
            const select = document.getElementById('publisher');
            publishers.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                select.appendChild(option);
            });
        }

        function populateCopyrights() {
            const select = document.getElementById('copyright');

            // Group by category
            const byCategory = {
                'base': [],
                'third-party': [],
                'footer': []
            };

            copyrights.forEach(c => {
                const category = c.category || 'third-party';
                if (!byCategory[category]) byCategory[category] = [];
                byCategory[category].push(c);
            });

            // Add optgroups
            if (byCategory.base.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üìÑ Base Copyright Headers';
                byCategory.base.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.name;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }

            if (byCategory['third-party'].length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üè¢ Third-Party Licenses';
                byCategory['third-party'].forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.name;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }

            if (byCategory.footer.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üìå Footer Statements';
                byCategory.footer.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.name;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // Copyright list management
        function addCopyrightNotice() {
            const select = document.getElementById('copyright');
            const copyrightId = select.value;

            if (!copyrightId) {
                showNotification('Please select a copyright notice to add', 'warning');
                return;
            }

            // Check if already added
            if (selectedCopyrights.includes(copyrightId)) {
                showNotification('Copyright notice already added', 'warning');
                return;
            }

            selectedCopyrights.push(copyrightId);
            renderCopyrightList();
            select.value = '';
            updatePreview();
        }

        function removeCopyrightNotice(copyrightId) {
            selectedCopyrights = selectedCopyrights.filter(id => id !== copyrightId);
            renderCopyrightList();
            updatePreview();
        }

        function moveCopyrightNotice(fromIndex, toIndex) {
            const item = selectedCopyrights[fromIndex];
            selectedCopyrights.splice(fromIndex, 1);
            selectedCopyrights.splice(toIndex, 0, item);
            renderCopyrightList();
            updatePreview();
        }

        function renderCopyrightList() {
            const container = document.getElementById('copyrightList');
            container.innerHTML = '';

            selectedCopyrights.forEach((copyrightId, index) => {
                const copyright = copyrights.find(c => c.id === copyrightId);
                if (!copyright) return;

                const item = document.createElement('div');
                item.className = 'copyright-item';
                item.draggable = true;
                item.dataset.index = index;
                item.dataset.id = copyrightId;

                // Drag handle
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.textContent = '‚ò∞';
                handle.title = 'Drag to reorder';

                // Name
                const name = document.createElement('span');
                name.className = 'copyright-item-name';
                name.textContent = copyright.name;

                // Category badge
                const category = document.createElement('span');
                category.className = 'copyright-item-category';
                const categoryLabels = {
                    'base': 'üìÑ',
                    'third-party': 'üè¢',
                    'footer': 'üìå'
                };
                category.textContent = categoryLabels[copyright.category] || 'üìÑ';
                category.title = copyright.category || 'base';

                // Remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-copyright';
                removeBtn.textContent = '√ó';
                removeBtn.title = 'Remove';
                removeBtn.onclick = () => removeCopyrightNotice(copyrightId);

                item.appendChild(handle);
                item.appendChild(name);
                item.appendChild(category);
                item.appendChild(removeBtn);

                // Drag events
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);

                container.appendChild(item);
            });
        }

        // Drag and drop handlers
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = e.currentTarget;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const targetElement = e.currentTarget;
            if (targetElement !== draggedElement) {
                targetElement.classList.add('drag-over');
            }

            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetElement = e.currentTarget;
            targetElement.classList.remove('drag-over');

            if (draggedElement !== targetElement) {
                const fromIndex = parseInt(draggedElement.dataset.index);
                const toIndex = parseInt(targetElement.dataset.index);
                moveCopyrightNotice(fromIndex, toIndex);
            }

            return false;
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.copyright-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function setupEventListeners() {
            // Update preview on any input change
            document.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('input', updatePreview);
                el.addEventListener('change', updatePreview);
            });

            // File upload handlers
            document.getElementById('loadFile').addEventListener('change', loadExistingValueSet);
            document.getElementById('codeListFile').addEventListener('change', loadCodeListFile);

            // Custom code system toggles
            document.getElementById('codeSystem').addEventListener('change', (e) => {
                document.getElementById('customCodeSystem').style.display =
                    e.target.value === 'custom' ? 'block' : 'none';
            });
            document.getElementById('filterSystem').addEventListener('change', (e) => {
                document.getElementById('customFilterSystem').style.display =
                    e.target.value === 'custom' ? 'block' : 'none';
            });
            document.getElementById('entireSystemSelect').addEventListener('change', (e) => {
                document.getElementById('entireSystemUrl').style.display =
                    e.target.value === 'custom' ? 'block' : 'none';
            });
        }

        function suggestName() {
            const title = document.getElementById('title').value;
            const name = title.split(/\s+/).map(word =>
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join('');
            document.getElementById('name').value = name;
            validateNameField();
            updatePreview();
        }

        function validateNameField() {
            const nameInput = document.getElementById('name');
            const name = nameInput.value;
            const version = document.getElementById('version').value;
            const warningDiv = document.getElementById('nameValidationWarning');
            const charCountSpan = document.getElementById('nameCharCount');

            const warnings = [];
            let hasError = false;

            // Clear previous styling
            nameInput.classList.remove('input-error', 'input-warning');

            if (name) {
                // Validate PascalCase format: [A-Z]([A-Za-z0-9_]){0,254}
                const namePattern = /^[A-Z]([A-Za-z0-9_]){0,254}$/;
                if (!namePattern.test(name)) {
                    warnings.push('‚ùå Name must be PascalCase (start with capital, no spaces or special chars except _)');
                    hasError = true;
                    nameInput.classList.add('input-error');
                } else if (name.length > 254) {
                    warnings.push('‚ùå Name must not exceed 254 characters');
                    hasError = true;
                    nameInput.classList.add('input-error');
                }

                // Calculate ID length
                const kebabName = name.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
                const majorVersion = version.split('.')[0];
                const fullVersion = version;

                // ID for latest version
                const currentId = `${kebabName}-${majorVersion}`;
                const currentIdLength = currentId.length;

                // ID for previous version (worst case)
                const futureId = `${kebabName}-${fullVersion}`;
                const futureIdLength = futureId.length;

                // Show character count
                charCountSpan.textContent = `(ID: ${currentIdLength}/64 chars)`;

                // Check length constraints
                if (currentIdLength > 64) {
                    warnings.push(`‚ùå Current ID length (${currentIdLength}) exceeds 64 character limit`);
                    hasError = true;
                    nameInput.classList.add('input-error');
                } else if (futureIdLength > 63) {
                    warnings.push(`‚ö†Ô∏è ID with full version (${futureIdLength} chars) may exceed recommended limit of 63`);
                    nameInput.classList.add('input-warning');
                } else if (currentIdLength > 60) {
                    warnings.push(`‚ö†Ô∏è ID length (${currentIdLength}) exceeds recommended 60 characters for latest versions`);
                    nameInput.classList.add('input-warning');
                }
            } else {
                charCountSpan.textContent = '';
            }

            // Display warnings
            if (warnings.length > 0) {
                warningDiv.innerHTML = warnings.map(w =>
                    `<div class="${hasError ? 'validation-error' : 'validation-warning'}">${w}</div>`
                ).join('');
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }

            updatePreview();
        }

        function selectComposeType(type) {
            // Update radio buttons
            document.querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`input[value="${type}"]`).closest('.radio-option').classList.add('selected');
            document.querySelector(`input[value="${type}"]`).checked = true;

            // Show/hide compose content
            document.querySelectorAll('.compose-content').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(`compose-${type}`).classList.add('active');

            updatePreview();
        }

        function generateValueSet() {
            const name = document.getElementById('name').value || 'ExampleValueSet';
            const version = document.getElementById('version').value || '1.0.0';
            const title = document.getElementById('title').value || '';
            const description = document.getElementById('description').value || '';
            const narrativeText = document.getElementById('narrativeText').value || description;
            const status = document.getElementById('status').value;
            const experimental = document.getElementById('experimental').checked;
            const date = document.getElementById('date').value;
            const identifier = document.getElementById('identifier').value;

            // Publisher and copyright
            const publisherId = document.getElementById('publisher').value;
            const publisher = publishers.find(p => p.id === publisherId);

            // Generate derived values
            const kebabName = name.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
            const majorVersion = version.split('.')[0];
            const id = `${kebabName}-${majorVersion}`;
            const url = `https://healthterminologies.gov.au/fhir/ValueSet/${kebabName}-${majorVersion}`;

            // Build copyright from selected notices with " \n\n" separator (per authoring guide)
            let copyrightText = '';
            if (selectedCopyrights.length > 0) {
                const currentYear = new Date().getFullYear();
                const copyrightParagraphs = selectedCopyrights.map(copyrightId => {
                    const copyrightTemplate = copyrights.find(c => c.id === copyrightId);
                    if (!copyrightTemplate) return '';
                    return copyrightTemplate.template
                        .replace(/\{\{year\}\}/g, currentYear)
                        .replace(/\{\{publisher\}\}/g, publisher?.name || '');
                }).filter(text => text.length > 0);

                copyrightText = copyrightParagraphs.join(' \n\n');
            }

            // Build narrative
            const narrativeDiv = `<div xmlns="http://www.w3.org/1999/xhtml"><h2>${title}</h2><tt>${url}</tt><p>${narrativeText}</p></div>`;

            // Build compose section
            const compose = buildCompose();

            const valueSet = {
                resourceType: 'ValueSet',
                id: id,
                meta: {
                    profile: [
                        'http://hl7.org/fhir/StructureDefinition/shareablevalueset',
                        'https://healthterminologies.gov.au/fhir/StructureDefinition/composed-value-set-4'
                    ]
                },
                text: {
                    status: 'generated',
                    div: narrativeDiv
                },
                url: url
            };

            // Add identifier if provided
            if (identifier) {
                valueSet.identifier = [{
                    system: 'urn:ietf:rfc:3986',
                    value: `urn:oid:${identifier}`
                }];
            }

            valueSet.version = version;
            valueSet.name = name;
            valueSet.title = title;
            valueSet.status = status;
            valueSet.experimental = experimental;

            if (date) {
                valueSet.date = date;
            }

            if (publisher) {
                valueSet.publisher = publisher.name;
                valueSet.contact = [{
                    telecom: [{
                        system: publisher.contact.system,
                        value: publisher.contact.value
                    }]
                }];
            }

            valueSet.description = description;

            if (copyrightText) {
                valueSet.copyright = copyrightText;
            }

            valueSet.compose = compose;

            return valueSet;
        }

        function buildCompose() {
            const composeType = document.querySelector('input[name="composeType"]:checked').value;
            const compose = { include: [] };

            switch (composeType) {
                case 'codeList': {
                    let system = document.getElementById('codeSystem').value;
                    if (system === 'custom') {
                        system = document.getElementById('customCodeSystem').value;
                    }
                    const codes = parseCodeList(document.getElementById('codeListInput').value);
                    if (codes.length > 0) {
                        compose.include.push({
                            system: system,
                            concept: codes
                        });
                    } else {
                        compose.include.push({ system: system });
                    }
                    break;
                }
                case 'ecl': {
                    const ecl = document.getElementById('eclExpression').value;
                    compose.include.push({
                        system: 'http://snomed.info/sct',
                        filter: [{
                            property: 'constraint',
                            op: '=',
                            value: ecl
                        }]
                    });
                    break;
                }
                case 'filter': {
                    let system = document.getElementById('filterSystem').value;
                    if (system === 'custom') {
                        system = document.getElementById('customFilterSystem').value;
                    }
                    compose.include.push({
                        system: system,
                        filter: [{
                            property: document.getElementById('filterProperty').value,
                            op: document.getElementById('filterOp').value,
                            value: document.getElementById('filterValue').value
                        }]
                    });
                    break;
                }
                case 'valueSetRef': {
                    compose.include.push({
                        valueSet: [document.getElementById('valueSetRefUrl').value]
                    });
                    break;
                }
                case 'entireSystem': {
                    let system = document.getElementById('entireSystemSelect').value;
                    if (system === 'custom') {
                        system = document.getElementById('entireSystemUrl').value;
                    }
                    compose.include.push({
                        system: system
                    });
                    break;
                }
            }

            return compose;
        }

        function parseCodeList(input) {
            const lines = input.trim().split('\n').filter(line => line.trim());
            return lines.map(line => {
                const parts = line.split(',').map(p => p.trim());
                const concept = { code: parts[0] };
                if (parts[1]) {
                    concept.display = parts[1];
                }
                return concept;
            });
        }

        function updatePreview() {
            const valueSet = generateValueSet();
            const json = JSON.stringify(valueSet, null, 2);
            document.getElementById('jsonPreview').innerHTML = syntaxHighlight(json);
        }

        function syntaxHighlight(json) {
            return json
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    }
                    return `<span class="${cls}">${match}</span>`;
                });
        }

        function downloadJSON() {
            const valueSet = generateValueSet();
            const json = JSON.stringify(valueSet, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ValueSet-${valueSet.id}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('ValueSet downloaded successfully!');
        }

        function copyToClipboard() {
            const valueSet = generateValueSet();
            const json = JSON.stringify(valueSet, null, 2);
            navigator.clipboard.writeText(json).then(() => {
                showNotification('Copied to clipboard!');
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            if (type === 'error') {
                notification.style.background = 'var(--error)';
            } else if (type === 'warning') {
                notification.style.background = 'var(--warning)';
            } else {
                notification.style.background = 'var(--success)';
            }
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        async function loadExistingValueSet(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const valueSet = JSON.parse(text);

                populateFormFromValueSet(valueSet);
                document.getElementById('loadedFileName').textContent = `Loaded: ${file.name}`;

                // Validate loaded resource and show warnings (but don't change values)
                const violations = validateLoadedResource(valueSet);
                if (violations.length > 0) {
                    const violationMsg = 'ValueSet loaded with validation warnings:\n' + violations.join('\n');
                    console.warn(violationMsg);
                    showNotification('ValueSet loaded - See validation warnings below', 'warning');
                } else {
                    showNotification('ValueSet loaded! Update version and date as needed.');
                }

                // Highlight version field
                document.getElementById('version').classList.add('version-highlight');

                // Trigger validation to show warnings
                validateNameField();

            } catch (err) {
                showNotification('Failed to parse JSON file', 'error');
                console.error(err);
            }

            event.target.value = '';
        }

        function validateLoadedResource(vs) {
            const violations = [];

            // Validate name format
            if (vs.name) {
                const namePattern = /^[A-Z]([A-Za-z0-9_]){0,254}$/;
                if (!namePattern.test(vs.name)) {
                    violations.push(`‚ö†Ô∏è Name "${vs.name}" does not conform to PascalCase format`);
                }
                if (vs.name.length > 254) {
                    violations.push(`‚ö†Ô∏è Name length (${vs.name.length}) exceeds 254 character limit`);
                }
            }

            // Validate ID length
            if (vs.id) {
                if (vs.id.length > 64) {
                    violations.push(`‚ö†Ô∏è ID length (${vs.id.length}) exceeds 64 character limit`);
                }
            }

            // Check if name matches title (PascalCase)
            if (vs.title && vs.name) {
                const expectedName = vs.title.split(/\s+/).map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ).join('');
                if (vs.name !== expectedName) {
                    violations.push(`‚ÑπÔ∏è Name "${vs.name}" differs from expected PascalCase of title "${expectedName}"`);
                }
            }

            return violations;
        }

        function populateFormFromValueSet(vs) {
            // Basic metadata
            document.getElementById('title').value = vs.title || '';
            document.getElementById('name').value = vs.name || '';
            document.getElementById('description').value = vs.description || '';
            document.getElementById('version').value = vs.version || '1.0.0';
            document.getElementById('status').value = vs.status || 'active';
            document.getElementById('experimental').checked = vs.experimental === true;

            // Set date to today for new version
            setDefaultDate();

            // Narrative text
            if (vs.text?.div) {
                // Extract text from div
                const match = vs.text.div.match(/<p>(.*?)<\/p>/);
                if (match) {
                    document.getElementById('narrativeText').value = match[1];
                }
            }

            // Identifier
            if (vs.identifier?.[0]?.value) {
                const oid = vs.identifier[0].value.replace('urn:oid:', '');
                document.getElementById('identifier').value = oid;
            }

            // Publisher - try to match
            if (vs.publisher) {
                const matchedPub = publishers.find(p => p.name === vs.publisher);
                if (matchedPub) {
                    document.getElementById('publisher').value = matchedPub.id;
                }
            }

            // Copyright - parse and match paragraphs to templates
            selectedCopyrights = [];
            if (vs.copyright) {
                // Split by " \n\n" (authoring guide separator)
                const paragraphs = vs.copyright.split(' \n\n');

                paragraphs.forEach(paragraph => {
                    const trimmed = paragraph.trim();
                    if (!trimmed) return;

                    // Try to match paragraph to a template
                    const matched = copyrights.find(c => {
                        // Remove year and publisher placeholders for matching
                        const template = c.template
                            .replace(/\{\{year\}\}/g, '\\d{4}')
                            .replace(/\{\{publisher\}\}/g, '.+?');

                        // Create regex pattern (escape special chars except our placeholders)
                        const pattern = template
                            .replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
                            .replace(/\\\\d\{4\}/g, '\\d{4}')
                            .replace(/\\\.\+\?/g, '.+?');

                        try {
                            const regex = new RegExp(pattern.substring(0, 100)); // Match first 100 chars for performance
                            return regex.test(trimmed.substring(0, 100));
                        } catch (e) {
                            // Fallback to simple string matching
                            return trimmed.includes(c.template.substring(0, 50).replace(/\{\{year\}\}/g, '').replace(/\{\{publisher\}\}/g, ''));
                        }
                    });

                    if (matched && !selectedCopyrights.includes(matched.id)) {
                        selectedCopyrights.push(matched.id);
                    }
                });

                renderCopyrightList();
            }

            // Compose section
            if (vs.compose?.include?.[0]) {
                const inc = vs.compose.include[0];

                if (inc.valueSet) {
                    // External ValueSet reference
                    selectComposeType('valueSetRef');
                    document.getElementById('valueSetRefUrl').value = inc.valueSet[0] || '';
                } else if (inc.filter) {
                    const filter = inc.filter[0];
                    if (filter.property === 'constraint') {
                        // ECL expression
                        selectComposeType('ecl');
                        document.getElementById('eclExpression').value = filter.value || '';
                    } else {
                        // Generic filter
                        selectComposeType('filter');
                        setFilterSystem(inc.system);
                        document.getElementById('filterProperty').value = filter.property || 'concept';
                        document.getElementById('filterOp').value = filter.op || '=';
                        document.getElementById('filterValue').value = filter.value || '';
                    }
                } else if (inc.concept) {
                    // Code list
                    selectComposeType('codeList');
                    setCodeSystem(inc.system);
                    const codeText = inc.concept.map(c =>
                        c.display ? `${c.code},${c.display}` : c.code
                    ).join('\n');
                    document.getElementById('codeListInput').value = codeText;
                } else if (inc.system) {
                    // Entire system
                    selectComposeType('entireSystem');
                    setEntireSystem(inc.system);
                }
            }

            updatePreview();
        }

        function setCodeSystem(system) {
            const select = document.getElementById('codeSystem');
            const options = Array.from(select.options).map(o => o.value);
            if (options.includes(system)) {
                select.value = system;
            } else {
                select.value = 'custom';
                document.getElementById('customCodeSystem').value = system;
                document.getElementById('customCodeSystem').style.display = 'block';
            }
        }

        function setFilterSystem(system) {
            const select = document.getElementById('filterSystem');
            const options = Array.from(select.options).map(o => o.value);
            if (options.includes(system)) {
                select.value = system;
            } else {
                select.value = 'custom';
                document.getElementById('customFilterSystem').value = system;
                document.getElementById('customFilterSystem').style.display = 'block';
            }
        }

        function setEntireSystem(system) {
            const select = document.getElementById('entireSystemSelect');
            const options = Array.from(select.options).map(o => o.value);
            if (options.includes(system)) {
                select.value = system;
            } else {
                select.value = 'custom';
                document.getElementById('entireSystemUrl').value = system;
                document.getElementById('entireSystemUrl').style.display = 'block';
            }
        }

        async function loadCodeListFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                document.getElementById('codeListInput').value = text;
                updatePreview();
                showNotification('Code list loaded!');
            } catch (err) {
                showNotification('Failed to read file', 'error');
            }

            event.target.value = '';
        }

        function clearForm() {
            document.getElementById('title').value = '';
            document.getElementById('name').value = '';
            document.getElementById('description').value = '';
            document.getElementById('narrativeText').value = '';
            document.getElementById('version').value = '1.0.0';
            document.getElementById('status').value = 'active';
            document.getElementById('experimental').checked = false;
            document.getElementById('identifier').value = '';
            document.getElementById('publisher').value = '';
            document.getElementById('copyright').value = '';
            selectedCopyrights = [];
            renderCopyrightList();
            document.getElementById('codeListInput').value = '';
            document.getElementById('eclExpression').value = '';
            document.getElementById('filterProperty').value = 'concept';
            document.getElementById('filterOp').value = '=';
            document.getElementById('filterValue').value = '';
            document.getElementById('valueSetRefUrl').value = '';
            document.getElementById('loadedFileName').textContent = '';
            document.getElementById('version').classList.remove('version-highlight');

            setDefaultDate();
            selectComposeType('codeList');
            updatePreview();
            showNotification('Form cleared');
        }
    </script>
</body>
</html>
